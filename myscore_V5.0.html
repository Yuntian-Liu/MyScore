<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyScore V5.0 - æ™ºèƒ½æˆç»©ç®¡å®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans SC', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            min-height: 100vh;
            color: #f8fafc;
        }
        
        .hidden { display: none !important; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: transparent;
            border: 1px solid transparent;
            color: #94a3b8;
            cursor: pointer;
        }
        
        .nav-btn:hover { color: #f8fafc; background: rgba(255,255,255,0.05); }
        .nav-btn.active { 
            background: rgba(99, 102, 241, 0.3); 
            border-color: rgba(99, 102, 241, 0.5);
            color: #f8fafc;
        }
        
        .input-glass {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 0.875rem 1rem;
            color: #f8fafc;
            width: 100%;
            outline: none;
        }
        
        .input-glass:focus {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4); }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .exam-type-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .exam-type-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(99, 102, 241, 0.4);
        }
        
        .exam-type-card.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.6);
        }
        
        .accordion-item {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }
        
        .accordion-header {
            padding: 1.25rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion-content.expanded { max-height: 1000px; }
        
        .accordion-arrow { transition: transform 0.3s ease; }
        .accordion-arrow.expanded { transform: rotate(180deg); }
        
        .dashboard-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #94a3b8;
            cursor: pointer;
            border: 1px solid transparent;
            background: transparent;
        }
        
        .dashboard-tab.active {
            color: #f8fafc;
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        
        .record-item {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background: linear-gradient(135deg, #1e1b4b 0%, #0f172a 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .empty-state { text-align: center; padding: 3rem; color: #64748b; }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 1rem; opacity: 0.3; }
        
        .score-tag {
            display: inline-flex;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header style="position: sticky; top: 0; z-index: 50; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="max-width: 1200px; margin: 0 auto; padding: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #6366f1, #9333ea); display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 style="font-size: 1.5rem; font-weight: bold;" class="gradient-text">MyScore</h1>
                            <p style="font-size: 0.75rem; color: #64748b;">V5.0 æ™ºèƒ½æˆç»©ç®¡å®¶</p>
                        </div>
                    </div>
                    <nav style="display: flex; gap: 0.5rem;">
                        <button class="nav-btn active" id="nav-dashboard" onclick="showPage('dashboard')">ä»ªè¡¨ç›˜</button>
                        <button class="nav-btn" id="nav-entry" onclick="showPage('entry')">å½•å…¥æˆç»©</button>
                        <button class="nav-btn" id="nav-custom" onclick="showPage('custom')">è‡ªå®šä¹‰è€ƒè¯•</button>
                    </nav>
                </div>
            </div>
        </header>

        <main style="max-width: 1200px; margin: 0 auto; padding: 2rem 1rem;">
            <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
            <div id="page-dashboard" class="page">
                <!-- æ¦‚è§ˆå¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="glass-card" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.25rem;">æ€»è€ƒè¯•æ¬¡æ•°</p>
                                <p id="total-count" style="font-size: 2rem; font-weight: bold; color: #22d3ee;">0</p>
                            </div>
                            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(34, 211, 238, 0.2); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="#22d3ee" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.25rem;">è€ƒè¯•ç±»å‹</p>
                                <p id="exam-types-count" style="font-size: 2rem; font-weight: bold;" class="gradient-text">0</p>
                            </div>
                            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(99, 102, 241, 0.2); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="#818cf8" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.25rem;">æœ€è¿‘è€ƒè¯•</p>
                                <p id="latest-exam-date" style="font-size: 1.25rem; font-weight: bold;">-</p>
                            </div>
                            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(236, 72, 153, 0.2); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="#f472b6" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘æˆç»© -->
                <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">ğŸ“Š æœ€è¿‘æˆç»©</h2>
                    <div id="recent-score-content">
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p>è¿˜æ²¡æœ‰æˆç»©è®°å½•</p>
                            <button onclick="showPage('entry')" style="margin-top: 1rem; color: #818cf8; cursor: pointer; background: none; border: none;">å¼€å§‹å½•å…¥ â†’</button>
                        </div>
                    </div>
                </div>

                <!-- Tab ç»Ÿè®¡ -->
                <div class="glass-card" style="padding: 1rem; margin-bottom: 1.5rem;">
                    <div id="dashboard-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="dashboard-tab active" onclick="switchDashboardTab('overview')">æ¦‚è§ˆ</button>
                    </div>
                    <div id="tab-content-overview">
                        <div class="empty-state">
                            <p>é€‰æ‹©ä¸Šæ–¹è€ƒè¯•ç±»å‹æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡</p>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®ç®¡ç† -->
                <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">ğŸ’¾ æ•°æ®ç®¡ç†</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="stat-card">
                            <h3 style="font-weight: 600; margin-bottom: 0.5rem;">å¯¼å‡ºå¤‡ä»½</h3>
                            <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">å¯¼å‡ºæ‰€æœ‰æˆç»©å’Œè®¾ç½®</p>
                            <button class="btn-secondary" onclick="exportData()" style="width: 100%;">å¯¼å‡ºæ•°æ®</button>
                            <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">å…± <span id="record-count">0</span> æ¡è®°å½•</p>
                        </div>
                        <div class="stat-card">
                            <h3 style="font-weight: 600; margin-bottom: 0.5rem;">å¯¼å…¥å¤‡ä»½</h3>
                            <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">ä»æ–‡ä»¶æ¢å¤æ•°æ®</p>
                            <label class="btn-primary" style="display: block; text-align: center; cursor: pointer;">
                                é€‰æ‹©æ–‡ä»¶
                                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importData(this)">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- å†å²è®°å½• -->
                <div class="glass-card" style="padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 600;">ğŸ“œ å†å²è®°å½•</h2>
                        <button onclick="clearAllRecords()" style="color: #f87171; background: none; border: none; cursor: pointer;">æ¸…ç©ºæ‰€æœ‰</button>
                    </div>
                    <div id="records-list"></div>
                </div>
            </div>

            <!-- å½•å…¥æˆç»©é¡µé¢ -->
            <div id="page-entry" class="page hidden">
                <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">é€‰æ‹©è€ƒè¯•ç±»å‹</h2>
                    <div id="exam-type-selector" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;"></div>
                </div>
                <div id="entry-form-container" class="glass-card" style="padding: 1.5rem;">
                    <div class="empty-state">
                        <p>è¯·é€‰æ‹©ä¸Šæ–¹è€ƒè¯•ç±»å‹å¼€å§‹å½•å…¥</p>
                    </div>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰è€ƒè¯•é¡µé¢ -->
            <div id="page-custom" class="page hidden">
                <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h2 style="font-size: 1.25rem; font-weight: 600;">è‡ªå®šä¹‰è€ƒè¯•ç±»å‹</h2>
                            <p style="color: #64748b; font-size: 0.875rem;">åˆ›å»ºä½ è‡ªå·±çš„è€ƒè¯•è¯„åˆ†ç³»ç»Ÿ</p>
                        </div>
                        <button class="btn-primary" onclick="openCreateModal()">+ æ–°å»ºè€ƒè¯•</button>
                    </div>
                    <div id="custom-exam-list"></div>
                </div>
            </div>
        </main>

        <!-- åˆ›å»ºè€ƒè¯•æ¨¡æ€æ¡† -->
        <div id="create-modal" class="modal-overlay" onclick="closeModalOnBackdrop(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="gradient-text" style="font-size: 1.5rem; font-weight: bold;">æ–°å»ºè€ƒè¯•ç±»å‹</h2>
                    <button onclick="closeCreateModal()" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.5rem;">Ã—</button>
                </div>
                <form id="create-exam-form" onsubmit="submitCreateForm(event)">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem;">è€ƒè¯•åç§°</label>
                        <input type="text" id="new-exam-name" required class="input-glass" placeholder="å¦‚ï¼šæ‰˜ç¦ã€GRE">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem;">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="new-exam-desc" class="input-glass" placeholder="ç®€çŸ­æè¿°">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label>ç§‘ç›®è®¾ç½®</label>
                            <button type="button" onclick="addSubject()" style="color: #818cf8; background: none; border: none; cursor: pointer;">+ æ·»åŠ ç§‘ç›®</button>
                        </div>
                        <div id="subjects-list"></div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn-secondary" onclick="closeCreateModal()" style="flex: 1;">å–æ¶ˆ</button>
                        <button type="submit" class="btn-primary" style="flex: 1;">åˆ›å»º</button>
                    </div>
                </form>
            </div>
        </div>

        <footer style="text-align: center; padding: 2rem; color: #475569;">
            <p>Copyright Â© LYT, 2026 All Rights Reserved</p>
            <p style="font-size: 0.75rem;">MyScore V5.0</p>
        </footer>
    </div>

    <script>
        // ==================== æ•°æ®å­˜å‚¨ ====================
        const STORAGE_KEYS = {
            RECORDS: 'myscore_v5_records',
            CUSTOM_EXAMS: 'myscore_v5_custom_exams'
        };

        // å†…ç½®è€ƒè¯•ç±»å‹
        const BUILTIN_EXAMS = {
            ielts: {
                id: 'ielts',
                name: 'é›…æ€',
                desc: 'IELTS Academic',
                icon: 'ğŸ“‹',
                builtin: true,
                subjects: [
                    { id: 'listening', name: 'Listening', shortName: 'L', color: '#3b82f6', type: 'lookup', min: 0, max: 40, decimals: 1 },
                    { id: 'reading', name: 'Reading', shortName: 'R', color: '#10b981', type: 'lookup', min: 0, max: 40, decimals: 1 },
                    { id: 'writing', name: 'Writing', shortName: 'W', color: '#f59e0b', type: 'direct', min: 0, max: 9, step: 0.5, decimals: 1 },
                    { id: 'speaking', name: 'Speaking', shortName: 'S', color: '#a855f7', type: 'direct', min: 0, max: 9, step: 0.5, decimals: 1 }
                ],
                calcOverall: true
            },
            cet4: {
                id: 'cet4',
                name: 'å››çº§',
                desc: 'CET-4',
                icon: 'ğŸ“š',
                builtin: true,
                subjects: [
                    { id: 'listening', name: 'å¬åŠ›', shortName: 'å¬', color: '#3b82f6', type: 'sections', sections: [
                        { name: 'çŸ­å¯¹è¯', points: 7.1, max: 8 },
                        { name: 'é•¿å¯¹è¯', points: 7.1, max: 7 },
                        { name: 'çŸ­æ–‡', points: 14.2, max: 10 }
                    ], decimals: 0 },
                    { id: 'reading', name: 'é˜…è¯»', shortName: 'è¯»', color: '#10b981', type: 'sections', sections: [
                        { name: 'é€‰è¯å¡«ç©º', points: 3.55, max: 10 },
                        { name: 'é•¿ç¯‡é˜…è¯»', points: 7.1, max: 10 },
                        { name: 'ä»”ç»†é˜…è¯»', points: 14.2, max: 10 }
                    ], decimals: 0 },
                    { id: 'writing', name: 'å†™ä½œ', shortName: 'å†™', color: '#f59e0b', type: 'formula', min: 0, max: 15, multiplier: 7.1, decimals: 0 },
                    { id: 'translation', name: 'ç¿»è¯‘', shortName: 'è¯‘', color: '#ef4444', type: 'formula', min: 0, max: 15, multiplier: 7.1, decimals: 0 }
                ],
                calcOverall: true
            },
            cet6: {
                id: 'cet6',
                name: 'å…­çº§',
                desc: 'CET-6',
                icon: 'ğŸ“',
                builtin: true,
                subjects: [
                    { id: 'listening', name: 'å¬åŠ›', shortName: 'å¬', color: '#3b82f6', type: 'sections', sections: [
                        { name: 'é•¿å¯¹è¯', points: 7.1, max: 8 },
                        { name: 'å¬åŠ›ç¯‡ç« ', points: 7.1, max: 7 },
                        { name: 'è®²åº§', points: 14.2, max: 10 }
                    ], decimals: 0 },
                    { id: 'reading', name: 'é˜…è¯»', shortName: 'è¯»', color: '#10b981', type: 'sections', sections: [
                        { name: 'é€‰è¯å¡«ç©º', points: 3.55, max: 10 },
                        { name: 'é•¿ç¯‡é˜…è¯»', points: 7.1, max: 10 },
                        { name: 'ä»”ç»†é˜…è¯»', points: 14.2, max: 10 }
                    ], decimals: 0 },
                    { id: 'writing', name: 'å†™ä½œ', shortName: 'å†™', color: '#f59e0b', type: 'formula', min: 0, max: 15, multiplier: 7.1, decimals: 0 },
                    { id: 'translation', name: 'ç¿»è¯‘', shortName: 'è¯‘', color: '#ef4444', type: 'formula', min: 0, max: 15, multiplier: 7.1, decimals: 0 }
                ],
                calcOverall: true
            }
        };

        // æŸ¥æ‰¾è¡¨
        const LOOKUP_TABLES = {
            listening: [{min:39,max:40,score:9.0},{min:37,max:38,score:8.5},{min:35,max:36,score:8.0},{min:32,max:34,score:7.5},{min:30,max:31,score:7.0},{min:26,max:29,score:6.5},{min:23,max:25,score:6.0},{min:18,max:22,score:5.5},{min:16,max:17,score:5.0},{min:13,max:15,score:4.5},{min:10,max:12,score:4.0},{min:6,max:9,score:3.5},{min:4,max:5,score:3.0},{min:3,max:3,score:2.5},{min:2,max:2,score:2.0},{min:1,max:1,score:1.0},{min:0,max:0,score:0.5}],
            reading: [{min:39,max:40,score:9.0},{min:37,max:38,score:8.5},{min:35,max:36,score:8.0},{min:33,max:34,score:7.5},{min:30,max:32,score:7.0},{min:27,max:29,score:6.5},{min:23,max:26,score:6.0},{min:19,max:22,score:5.5},{min:15,max:18,score:5.0},{min:13,max:14,score:4.5},{min:10,max:12,score:4.0},{min:8,max:9,score:3.5},{min:6,max:7,score:3.0},{min:4,max:5,score:2.5},{min:3,max:3,score:2.5},{min:2,max:2,score:2.0},{min:1,max:1,score:1.0},{min:0,max:0,score:0.5}]
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        function getRecords() {
            const data = localStorage.getItem(STORAGE_KEYS.RECORDS);
            return data ? JSON.parse(data) : [];
        }

        function saveRecords(records) {
            localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(records));
        }

        function getCustomExams() {
            const data = localStorage.getItem(STORAGE_KEYS.CUSTOM_EXAMS);
            return data ? JSON.parse(data) : {};
        }

        function saveCustomExams(exams) {
            localStorage.setItem(STORAGE_KEYS.CUSTOM_EXAMS, JSON.stringify(exams));
        }

        function getAllExams() {
            return { ...BUILTIN_EXAMS, ...getCustomExams() };
        }

        function roundUp(n) { return Math.ceil(n); }

        function calcIeltsOverall(scores) {
            const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
            const dec = avg - Math.floor(avg);
            if (dec >= 0.25 && dec < 0.5) return Math.floor(avg) + 0.5;
            if (dec >= 0.75) return Math.floor(avg) + 1.0;
            return Math.round(avg*2)/2;
        }

        function lookupScore(raw, type) {
            const table = LOOKUP_TABLES[type];
            const val = parseInt(raw) || 0;
            for (const item of table) {
                if (val >= item.min && val <= item.max) return item.score;
            }
            return 0;
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showPage(page) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById('page-' + page).classList.remove('hidden');
            // æ›´æ–°å¯¼èˆªæŒ‰é’®
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + page).classList.add('active');
            
            // é¡µé¢ç‰¹å®šåˆå§‹åŒ–
            if (page === 'dashboard') {
                renderDashboard();
            } else if (page === 'entry') {
                renderExamSelector();
                document.getElementById('entry-form-container').innerHTML = '<div class="empty-state"><p>è¯·é€‰æ‹©ä¸Šæ–¹è€ƒè¯•ç±»å‹å¼€å§‹å½•å…¥</p></div>';
            } else if (page === 'custom') {
                renderCustomList();
            }
        }

        // ==================== ä»ªè¡¨ç›˜ ====================
        function renderDashboard() {
            const records = getRecords();
            const exams = getAllExams();
            
            // ç»Ÿè®¡
            document.getElementById('total-count').textContent = records.length;
            const types = [...new Set(records.map(r => r.examType))];
            document.getElementById('exam-types-count').textContent = types.length;
            document.getElementById('record-count').textContent = records.length;
            
            if (records.length > 0) {
                document.getElementById('latest-exam-date').textContent = records[records.length-1].date;
            } else {
                document.getElementById('latest-exam-date').textContent = '-';
            }
            
            // æœ€è¿‘æˆç»©
            const recentDiv = document.getElementById('recent-score-content');
            if (records.length === 0) {
                recentDiv.innerHTML = '<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><p>è¿˜æ²¡æœ‰æˆç»©è®°å½•</p><button onclick="showPage(\'entry\')" style="margin-top:1rem;color:#818cf8;background:none;border:none;cursor:pointer;">å¼€å§‹å½•å…¥ â†’</button></div>';
            } else {
                const latest = records[records.length-1];
                const exam = exams[latest.examType];
                let html = '<div style="margin-bottom:0.5rem;color:#64748b;">' + latest.date + ' - ' + (exam ? exam.name : 'æœªçŸ¥') + '</div><div style="display:flex;gap:1rem;flex-wrap:wrap;">';
                if (exam) {
                    for (const s of exam.subjects) {
                        const score = latest.scores[s.id] || 0;
                        html += '<div style="background:' + s.color + '20;border:1px solid ' + s.color + '40;padding:0.75rem 1rem;border-radius:0.75rem;text-align:center;"><div style="font-size:0.75rem;color:' + s.color + ';">' + s.name + '</div><div style="font-size:1.5rem;font-weight:bold;color:' + s.color + ';">' + score.toFixed(s.decimals) + '</div></div>';
                    }
                }
                html += '</div>';
                if (latest.total !== null) {
                    html += '<div style="margin-top:1rem;padding:1rem;background:rgba(99,102,241,0.1);border-radius:0.75rem;text-align:center;"><div style="font-size:0.875rem;color:#64748b;">æ€»åˆ†</div><div style="font-size:2.5rem;font-weight:bold;" class="gradient-text">' + latest.total.toFixed(1) + '</div></div>';
                }
                recentDiv.innerHTML = html;
            }
            
            // Tabs
            const tabsDiv = document.getElementById('dashboard-tabs');
            let tabsHtml = '<button class="dashboard-tab active" onclick="switchDashboardTab(\'overview\')">æ¦‚è§ˆ</button>';
            for (const typeId of types) {
                const exam = exams[typeId];
                if (exam) {
                    tabsHtml += '<button class="dashboard-tab" onclick="switchDashboardTab(\'' + typeId + '\')">' + exam.icon + ' ' + exam.name + '</button>';
                }
            }
            tabsDiv.innerHTML = tabsHtml;
            
            // å†å²è®°å½•
            const listDiv = document.getElementById('records-list');
            if (records.length === 0) {
                listDiv.innerHTML = '<div class="empty-state" style="padding:2rem;"><p>æš‚æ— å†å²è®°å½•</p></div>';
            } else {
                let listHtml = '';
                for (let i = records.length - 1; i >= 0; i--) {
                    const r = records[i];
                    const exam = exams[r.examType];
                    if (!exam) continue;
                    let badges = '';
                    for (const s of exam.subjects) {
                        const score = r.scores[s.id] || 0;
                        badges += '<span class="score-tag" style="background:' + s.color + '20;color:' + s.color + ';border:1px solid ' + s.color + '40;">' + s.shortName + ': ' + score.toFixed(s.decimals) + '</span>';
                    }
                    listHtml += '<div class="record-item"><div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;"><span>' + exam.icon + '</span><span style="font-weight:600;">' + exam.name + '</span><span style="color:#64748b;font-size:0.875rem;">' + r.date + '</span></div><div>' + badges + '</div></div><div style="display:flex;align-items:center;gap:1rem;">' + (r.total !== null ? '<div style="text-align:right;"><div style="font-size:0.75rem;color:#64748b;">æ€»åˆ†</div><div style="font-size:1.5rem;font-weight:bold;" class="gradient-text">' + r.total.toFixed(1) + '</div></div>' : '') + '<button onclick="deleteRecord(' + r.id + ')" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:1.25rem;">Ã—</button></div></div></div>';
                }
                listDiv.innerHTML = listHtml;
            }
        }

        function switchDashboardTab(tab) {
            document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const container = document.getElementById('tab-content-overview');
            if (tab === 'overview') {
                container.innerHTML = '<div class="empty-state"><p>é€‰æ‹©ä¸Šæ–¹è€ƒè¯•ç±»å‹æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡</p></div>';
                return;
            }
            
            const exams = getAllExams();
            const exam = exams[tab];
            const records = getRecords().filter(r => r.examType === tab);
            
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— ' + exam.name + 'æ•°æ®</p></div>';
                return;
            }
            
            let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem;">';
            html += '<div class="stat-card"><p style="color:#64748b;font-size:0.875rem;">è€ƒè¯•æ¬¡æ•°</p><p style="font-size:2rem;font-weight:bold;" class="gradient-text">' + records.length + '</p></div>';
            html += '<div class="stat-card"><p style="color:#64748b;font-size:0.875rem;">æœ€è¿‘è€ƒè¯•</p><p style="font-size:1.25rem;font-weight:bold;">' + records[records.length-1].date + '</p></div>';
            if (exam.calcOverall) {
                const totals = records.map(r => r.total);
                html += '<div class="stat-card"><p style="color:#64748b;font-size:0.875rem;">æœ€ä½³æ€»åˆ†</p><p style="font-size:2rem;font-weight:bold;color:#22d3ee;">' + Math.max(...totals).toFixed(1) + '</p></div>';
                html += '<div class="stat-card"><p style="color:#64748b;font-size:0.875rem;">å¹³å‡æ€»åˆ†</p><p style="font-size:2rem;font-weight:bold;color:#c084fc;">' + (totals.reduce((a,b)=>a+b,0)/totals.length).toFixed(1) + '</p></div>';
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function deleteRecord(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
            const records = getRecords().filter(r => r.id !== id);
            saveRecords(records);
            renderDashboard();
        }

        function clearAllRecords() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            localStorage.removeItem(STORAGE_KEYS.RECORDS);
            renderDashboard();
        }


        // ==================== å½•å…¥æˆç»© ====================
        let currentExamType = null;

        function renderExamSelector() {
            const exams = getAllExams();
            const container = document.getElementById('exam-type-selector');
            let html = '';
            for (const [id, exam] of Object.entries(exams)) {
                html += '<div class="exam-type-card" onclick="selectExamType(\'' + id + '\')"><div style="font-size:2rem;margin-bottom:0.5rem;">' + exam.icon + '</div><div style="font-weight:600;">' + exam.name + '</div><div style="font-size:0.75rem;color:#64748b;">' + exam.desc + '</div></div>';
            }
            container.innerHTML = html;
        }

        function selectExamType(typeId) {
            currentExamType = typeId;
            const exams = getAllExams();
            const exam = exams[typeId];
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.exam-type-card').forEach((card, idx) => {
                const keys = Object.keys(exams);
                if (keys[idx] === typeId) card.classList.add('active');
                else card.classList.remove('active');
            });
            
            // æ¸²æŸ“è¡¨å•
            let html = '<form onsubmit="submitScore(event)"><div style="margin-bottom:1rem;"><label style="display:block;margin-bottom:0.5rem;">è€ƒè¯•æ—¥æœŸ</label><input type="date" id="score-date" required class="input-glass" style="max-width:200px;"></div>';
            
            for (let i = 0; i < exam.subjects.length; i++) {
                const s = exam.subjects[i];
                const isOpen = i === 0 ? 'expanded' : '';
                const arrowClass = i === 0 ? 'expanded' : '';
                
                html += '<div class="accordion-item" style="border-left:3px solid ' + s.color + ';"><div class="accordion-header" onclick="toggleAccordion(this)"><div style="display:flex;align-items:center;gap:0.75rem;"><div style="width:36px;height:36px;border-radius:8px;background:' + s.color + ';display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">' + s.shortName + '</div><div><div style="font-weight:600;">' + s.name + '</div></div></div><svg class="accordion-arrow ' + arrowClass + '" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div><div class="accordion-content ' + isOpen + '"><div style="padding:0 1rem 1rem;">';
                
                if (s.type === 'direct') {
                    html += '<input type="number" id="sub-' + s.id + '" min="' + s.min + '" max="' + s.max + '" step="' + (s.step || 1) + '" class="input-glass" placeholder="' + s.min + '-' + s.max + '" oninput="updatePreview()">';
                } else if (s.type === 'lookup') {
                    html += '<input type="number" id="sub-' + s.id + '" min="' + s.min + '" max="' + s.max + '" class="input-glass" placeholder="æ­£ç¡®é¢˜æ•° (' + s.min + '-' + s.max + ')" oninput="updatePreview()"><div style="margin-top:0.5rem;padding:0.75rem;background:' + s.color + '15;border-radius:0.5rem;"><span style="color:' + s.color + '">æŠ˜ç®—åˆ†: </span><strong id="calc-' + s.id + '" style="color:' + s.color + ';">-</strong></div>';
                } else if (s.type === 'sections') {
                    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.5rem;">';
                    for (const sec of s.sections) {
                        html += '<div><label style="font-size:0.75rem;color:#64748b;">' + sec.name + '</label><input type="number" id="sub-' + s.id + '-' + sec.name + '" min="0" max="' + sec.max + '" class="input-glass" placeholder="0-' + sec.max + '" oninput="updatePreview()"></div>';
                    }
                    html += '</div><div style="margin-top:0.5rem;padding:0.75rem;background:' + s.color + '15;border-radius:0.5rem;"><span style="color:' + s.color + '">æ€»åˆ†: </span><strong id="calc-' + s.id + '" style="color:' + s.color + ';">-</strong></div>';
                } else if (s.type === 'formula') {
                    html += '<input type="number" id="sub-' + s.id + '" min="' + s.min + '" max="' + s.max + '" step="0.5" class="input-glass" placeholder="åŸå§‹åˆ† (' + s.min + '-' + s.max + ')" oninput="updatePreview()"><div style="margin-top:0.5rem;padding:0.75rem;background:' + s.color + '15;border-radius:0.5rem;"><span style="color:' + s.color + '">æŠ˜ç®—åˆ†: </span><strong id="calc-' + s.id + '" style="color:' + s.color + ';">-</strong></div>';
                }
                
                html += '</div></div></div>';
            }
            
            if (exam.calcOverall) {
                html += '<div style="margin:1.5rem 0;padding:1.5rem;background:rgba(99,102,241,0.1);border-radius:1rem;border:1px solid rgba(99,102,241,0.3);"><div style="display:flex;justify-content:space-between;align-items:center;"><span>æ€»åˆ†é¢„è§ˆ</span><span id="preview-total" style="font-size:2.5rem;font-weight:bold;" class="gradient-text">-</span></div></div>';
            }
            
            html += '<button type="submit" class="btn-primary" style="width:100%;">ä¿å­˜æˆç»©</button></form>';
            
            document.getElementById('entry-form-container').innerHTML = html;
            document.getElementById('score-date').value = new Date().toISOString().split('T')[0];
        }

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.accordion-arrow');
            content.classList.toggle('expanded');
            arrow.classList.toggle('expanded');
        }

        function updatePreview() {
            if (!currentExamType) return;
            const exams = getAllExams();
            const exam = exams[currentExamType];
            const scores = {};
            
            for (const s of exam.subjects) {
                if (s.type === 'direct') {
                    scores[s.id] = parseFloat(document.getElementById('sub-' + s.id)?.value) || 0;
                } else if (s.type === 'lookup') {
                    const raw = document.getElementById('sub-' + s.id)?.value || '';
                    const score = raw ? lookupScore(raw, s.id) : 0;
                    scores[s.id] = score;
                    document.getElementById('calc-' + s.id).textContent = score.toFixed(s.decimals);
                } else if (s.type === 'sections') {
                    let sum = 0;
                    for (const sec of s.sections) {
                        const count = parseInt(document.getElementById('sub-' + s.id + '-' + sec.name)?.value) || 0;
                        sum += count * sec.points;
                    }
                    scores[s.id] = roundUp(sum);
                    document.getElementById('calc-' + s.id).textContent = scores[s.id];
                } else if (s.type === 'formula') {
                    const raw = parseFloat(document.getElementById('sub-' + s.id)?.value) || 0;
                    scores[s.id] = roundUp(raw * s.multiplier);
                    document.getElementById('calc-' + s.id).textContent = scores[s.id];
                }
            }
            
            if (exam.calcOverall) {
                let total = 0;
                if (exam.id === 'ielts') {
                    total = calcIeltsOverall(Object.values(scores));
                } else {
                    total = Object.values(scores).reduce((a,b)=>a+b,0);
                }
                document.getElementById('preview-total').textContent = total.toFixed(1);
            }
        }

        function submitScore(e) {
            e.preventDefault();
            if (!currentExamType) return;
            
            const exams = getAllExams();
            const exam = exams[currentExamType];
            const scores = {};
            
            for (const s of exam.subjects) {
                if (s.type === 'direct') {
                    scores[s.id] = parseFloat(document.getElementById('sub-' + s.id)?.value) || 0;
                } else if (s.type === 'lookup') {
                    scores[s.id] = lookupScore(document.getElementById('sub-' + s.id)?.value, s.id);
                } else if (s.type === 'sections') {
                    let sum = 0;
                    for (const sec of s.sections) {
                        const count = parseInt(document.getElementById('sub-' + s.id + '-' + sec.name)?.value) || 0;
                        sum += count * sec.points;
                    }
                    scores[s.id] = roundUp(sum);
                } else if (s.type === 'formula') {
                    const raw = parseFloat(document.getElementById('sub-' + s.id)?.value) || 0;
                    scores[s.id] = roundUp(raw * s.multiplier);
                }
            }
            
            let total = null;
            if (exam.calcOverall) {
                if (exam.id === 'ielts') {
                    total = calcIeltsOverall(Object.values(scores));
                } else {
                    total = Object.values(scores).reduce((a,b)=>a+b,0);
                }
            }
            
            const record = {
                id: Date.now(),
                examType: currentExamType,
                date: document.getElementById('score-date').value,
                scores: scores,
                total: total
            };
            
            const records = getRecords();
            records.push(record);
            saveRecords(records);
            
            alert('æˆç»©ä¿å­˜æˆåŠŸï¼');
            showPage('dashboard');
        }


        // ==================== è‡ªå®šä¹‰è€ƒè¯• ====================
        let customSubjects = [];

        function renderCustomList() {
            const exams = getCustomExams();
            const container = document.getElementById('custom-exam-list');
            
            if (Object.keys(exams).length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding:2rem;"><p>è¿˜æ²¡æœ‰è‡ªå®šä¹‰è€ƒè¯•ç±»å‹</p><p style="font-size:0.875rem;margin-top:0.5rem;">ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®åˆ›å»º</p></div>';
                return;
            }
            
            let html = '';
            for (const [id, exam] of Object.entries(exams)) {
                let subjectsHtml = '';
                for (const s of exam.subjects) {
                    subjectsHtml += '<span style="display:inline-block;padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;margin-right:0.5rem;background:' + s.color + '20;color:' + s.color + ';">' + s.name + '</span>';
                }
                html += '<div class="record-item"><div style="display:flex;justify-content:space-between;align-items:center;"><div style="display:flex;align-items:center;gap:1rem;"><div style="font-size:2rem;">' + exam.icon + '</div><div><div style="font-weight:600;">' + exam.name + '</div><div style="font-size:0.875rem;color:#64748b;">' + (exam.desc || 'æ— æè¿°') + '</div><div style="margin-top:0.5rem;">' + subjectsHtml + '</div></div></div><button onclick="deleteCustomExam(\'' + id + '\')" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:1.25rem;">Ã—</button></div></div>';
            }
            container.innerHTML = html;
        }

        function openCreateModal() {
            customSubjects = [];
            document.getElementById('create-exam-form').reset();
            document.getElementById('subjects-list').innerHTML = '';
            document.getElementById('create-modal').classList.add('active');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
        }

        function closeModalOnBackdrop(e) {
            if (e.target.id === 'create-modal') closeCreateModal();
        }

        function addSubject() {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#a855f7', '#ef4444', '#06b6d4'];
            const color = colors[customSubjects.length % colors.length];
            customSubjects.push({ name: '', short: '', color: color, type: 'direct', min: 0, max: 100 });
            renderSubjectsList();
        }

        function renderSubjectsList() {
            const container = document.getElementById('subjects-list');
            if (customSubjects.length === 0) {
                container.innerHTML = '<p style="color:#64748b;text-align:center;padding:1rem;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç§‘ç›®</p>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < customSubjects.length; i++) {
                const s = customSubjects[i];
                html += '<div style="padding:1rem;background:rgba(15,23,42,0.5);border-radius:0.75rem;margin-bottom:0.75rem;">';
                html += '<div style="display:grid;grid-template-columns:1fr 1fr auto;gap:0.5rem;margin-bottom:0.5rem;">';
                html += '<input type="text" placeholder="ç§‘ç›®åç§°" value="' + s.name + '" onchange="customSubjects[' + i + '].name=this.value" class="input-glass">';
                html += '<input type="text" placeholder="ç®€ç§°" value="' + s.short + '" onchange="customSubjects[' + i + '].short=this.value" class="input-glass" style="max-width:80px;">';
                html += '<input type="color" value="' + s.color + '" onchange="customSubjects[' + i + '].color=this.value" style="width:40px;height:40px;border:none;border-radius:0.5rem;cursor:pointer;">';
                html += '</div>';
                html += '<select onchange="customSubjects[' + i + '].type=this.value;renderSubjectsList()" class="input-glass" style="margin-bottom:0.5rem;">';
                html += '<option value="direct" ' + (s.type==='direct'?'selected':'') + '>ç›´æ¥è¾“å…¥åˆ†æ•°</option>';
                html += '<option value="lookup" ' + (s.type==='lookup'?'selected':'') + '>æŸ¥æ‰¾è¡¨è½¬æ¢</option>';
                html += '<option value="sections" ' + (s.type==='sections'?'selected':'') + '>åˆ†éƒ¨åˆ†è®¡åˆ†</option>';
                html += '<option value="formula" ' + (s.type==='formula'?'selected':'') + '>å…¬å¼è®¡ç®—</option>';
                html += '</select>';
                
                if (s.type === 'direct' || s.type === 'lookup') {
                    html += '<div style="display:flex;gap:0.5rem;"><input type="number" placeholder="æœ€å°å€¼" value="' + s.min + '" onchange="customSubjects[' + i + '].min=parseFloat(this.value)" class="input-glass"><input type="number" placeholder="æœ€å¤§å€¼" value="' + s.max + '" onchange="customSubjects[' + i + '].max=parseFloat(this.value)" class="input-glass"></div>';
                } else if (s.type === 'formula') {
                    html += '<div style="display:flex;gap:0.5rem;"><input type="number" placeholder="åŸå§‹åˆ†æœ€å¤§å€¼" value="' + (s.max||15) + '" onchange="customSubjects[' + i + '].max=parseFloat(this.value)" class="input-glass"><input type="number" placeholder="ä¹˜æ•°" value="' + (s.multiplier||7.1) + '" onchange="customSubjects[' + i + '].multiplier=parseFloat(this.value)" class="input-glass"></div>';
                } else if (s.type === 'sections') {
                    if (!s.sections) s.sections = [{name:'éƒ¨åˆ†1',points:1,max:10}];
                    html += '<div id="sections-' + i + '">';
                    for (let j = 0; j < s.sections.length; j++) {
                        const sec = s.sections[j];
                        html += '<div style="display:flex;gap:0.5rem;margin-bottom:0.25rem;"><input type="text" placeholder="åç§°" value="' + sec.name + '" onchange="customSubjects[' + i + '].sections[' + j + '].name=this.value" class="input-glass" style="flex:1;"><input type="number" placeholder="åˆ†å€¼" value="' + sec.points + '" onchange="customSubjects[' + i + '].sections[' + j + '].points=parseFloat(this.value)" class="input-glass" style="width:80px;"><input type="number" placeholder="æœ€å¤§é¢˜æ•°" value="' + sec.max + '" onchange="customSubjects[' + i + '].sections[' + j + '].max=parseInt(this.value)" class="input-glass" style="width:80px;"></div>';
                    }
                    html += '</div><button type="button" onclick="addSection(' + i + ')" style="color:#818cf8;background:none;border:none;cursor:pointer;font-size:0.875rem;">+ æ·»åŠ éƒ¨åˆ†</button>';
                }
                
                html += '<button type="button" onclick="removeSubject(' + i + ')" style="color:#f87171;background:none;border:none;cursor:pointer;font-size:0.875rem;margin-top:0.5rem;">åˆ é™¤ç§‘ç›®</button>';
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function addSection(subjectIdx) {
            customSubjects[subjectIdx].sections.push({name:'',points:1,max:10});
            renderSubjectsList();
        }

        function removeSubject(idx) {
            customSubjects.splice(idx, 1);
            renderSubjectsList();
        }

        function submitCreateForm(e) {
            e.preventDefault();
            
            if (customSubjects.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªç§‘ç›®ï¼');
                return;
            }
            
            for (const s of customSubjects) {
                if (!s.name || !s.short) {
                    alert('è¯·å¡«å†™æ‰€æœ‰ç§‘ç›®çš„åç§°å’Œç®€ç§°ï¼');
                    return;
                }
            }
            
            const exam = {
                id: 'custom_' + Date.now(),
                name: document.getElementById('new-exam-name').value,
                desc: document.getElementById('new-exam-desc').value,
                icon: 'ğŸ“',
                builtin: false,
                subjects: customSubjects,
                calcOverall: true
            };
            
            const exams = getCustomExams();
            exams[exam.id] = exam;
            saveCustomExams(exams);
            
            closeCreateModal();
            renderCustomList();
            alert('è€ƒè¯•ç±»å‹åˆ›å»ºæˆåŠŸï¼');
        }

        function deleteCustomExam(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªè€ƒè¯•ç±»å‹ï¼Ÿç›¸å…³æˆç»©ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) return;
            const exams = getCustomExams();
            delete exams[id];
            saveCustomExams(exams);
            
            // åˆ é™¤ç›¸å…³è®°å½•
            const records = getRecords().filter(r => r.examType !== id);
            saveRecords(records);
            
            renderCustomList();
        }


        // ==================== æ•°æ®å¯¼å…¥å¯¼å‡º ====================
        function exportData() {
            const records = getRecords();
            const customExams = getCustomExams();
            
            if (records.length === 0 && Object.keys(customExams).length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            const data = {
                version: '5.0',
                exportDate: new Date().toISOString(),
                records: records,
                customExams: customExams
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'MyScore_Backup_' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('å¯¼å‡ºæˆåŠŸï¼\nè®°å½•: ' + records.length + ' æ¡\nè‡ªå®šä¹‰è€ƒè¯•: ' + Object.keys(customExams).length + ' ä¸ª');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.version) throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    
                    // å¯¼å…¥è®°å½•
                    let newRecords = 0;
                    if (data.records) {
                        const existing = getRecords();
                        const existingIds = new Set(existing.map(r => r.id));
                        for (const r of data.records) {
                            if (!existingIds.has(r.id)) {
                                existing.push(r);
                                newRecords++;
                            }
                        }
                        saveRecords(existing);
                    }
                    
                    // å¯¼å…¥è‡ªå®šä¹‰è€ƒè¯•
                    let newExams = 0;
                    if (data.customExams) {
                        const existing = getCustomExams();
                        for (const [id, exam] of Object.entries(data.customExams)) {
                            if (!existing[id]) {
                                existing[id] = exam;
                                newExams++;
                            }
                        }
                        saveCustomExams(existing);
                    }
                    
                    alert('å¯¼å…¥æˆåŠŸï¼\næ–°è®°å½•: ' + newRecords + ' æ¡\næ–°è€ƒè¯•ç±»å‹: ' + newExams + ' ä¸ª');
                    renderDashboard();
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            renderDashboard();
        });
    </script>
</body>
</html>
