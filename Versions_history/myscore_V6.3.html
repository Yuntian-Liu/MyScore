<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyScore V6.3 - AI æ™ºèƒ½æˆç»©å•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-main: #faf8f5;
            --bg-card: #ffffff;
            --primary: #10b981;
            --primary-dark: #059669;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --listening: #3b82f6;
            --reading: #10b981;
            --writing: #f59e0b;
            --speaking: #8b5cf6;
            --translation: #ef4444;
        }

        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif; }

        body {
            background: linear-gradient(135deg, #faf8f5 0%, #f3f0eb 100%);
            min-height: 100vh;
            color: var(--text-main);
        }

        .hidden { display: none !important; }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(16, 185, 129, 0.1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.3);
        }

        /* å¯¼èˆªæŒ‰é’® */
        .nav-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
        }

        .nav-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        /* ä¸»æŒ‰é’® */
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        /* æ¬¡æŒ‰é’® */
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.875rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        /* è€ƒè¯•ç±»å‹å¡ç‰‡ */
        .exam-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exam-card:hover {
            border-color: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
        }

        .exam-card.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }

        /* ç§‘ç›®æ‰‹é£ç´ */
        .subject-box {
            border-radius: 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .subject-box.listening { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #3b82f6; }
        .subject-box.reading { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; }
        .subject-box.writing { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 2px solid #f59e0b; }
        .subject-box.speaking { background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border: 2px solid #8b5cf6; }
        .subject-box.translation { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 2px solid #ef4444; }

        .accordion-header {
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .accordion-content.expanded {
            max-height: 600px;
        }

        .accordion-arrow {
            transition: transform 0.3s ease;
            width: 20px;
            height: 20px;
        }

        .accordion-arrow.expanded {
            transform: rotate(180deg);
        }

        /* è¾“å…¥æ¡† */
        .input {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.875rem 1rem;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
            color: #1f2937;
        }

        .input:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Tab */
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #10b981;
        }

        .tab-btn.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-box {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border-color: #10b981;
        }

        /* è®°å½•é¡¹ */
        .record-box {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .record-box:hover {
            border-color: #10b981;
            transform: translateX(4px);
        }

        /* åˆ†æ•°æ ‡ç­¾ */
        .score-badge {
            display: inline-flex;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        /* æ¸å˜æ–‡å­— */
        .gradient-text {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }

        /* æ€»åˆ†é¢„è§ˆ */
        .total-preview {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 1rem;
            padding: 1.5rem;
        }

        /* Task åˆ†æ•°æ¡† */
        .task-box {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- å¤´éƒ¨ -->
        <header style="position: sticky; top: 0; z-index: 50; background: rgba(250, 248, 245, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(16, 185, 129, 0.1);">
            <div style="max-width: 1200px; margin: 0 auto; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                            <div>
                         <h1 style="font-size: 1.75rem; font-weight: bold;" class="gradient-text">MyScore</h1>
                         <p style="font-size: 0.875rem; color: #6b7280;">V6.3 AIæ™ºèƒ½æˆç»©å•</p>
                        </div>
                    </div>
                    <nav style="display: flex; gap: 0.5rem;">
                        <button class="nav-btn active" id="nav-dashboard" onclick="showPage('dashboard')">ä»ªè¡¨ç›˜</button>
                        <button class="nav-btn" id="nav-entry" onclick="showPage('entry')">å½•å…¥æˆç»©</button>
                        <button class="nav-btn" id="nav-custom" onclick="showPage('custom')">è‡ªå®šä¹‰è€ƒè¯•</button>
                    </nav>
                </div>
            </div>
        </header>

        <main style="max-width: 1200px; margin: 0 auto; padding: 2rem 1rem;">
            <!-- ä»ªè¡¨ç›˜ -->
            <div id="page-dashboard" class="page">
                <!-- æ¦‚è§ˆå¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="card" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">æ€»è€ƒè¯•æ¬¡æ•°</p>
                                <p id="total-count" style="font-size: 2.5rem; font-weight: bold; color: #10b981;">0</p>
                            </div>
                            <div style="width: 56px; height: 56px; border-radius: 16px; background: linear-gradient(135deg, #ecfdf5, #d1fae5); display: flex; align-items: center; justify-content: center;">
                                <svg width="28" height="28" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">è€ƒè¯•ç±»å‹</p>
                                <p id="exam-types-count" style="font-size: 2.5rem; font-weight: bold;" class="gradient-text">0</p>
                            </div>
                            <div style="width: 56px; height: 56px; border-radius: 16px; background: linear-gradient(135deg, #eff6ff, #dbeafe); display: flex; align-items: center; justify-content: center;">
                                <svg width="28" height="28" fill="none" stroke="#3b82f6" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">æœ€è¿‘è€ƒè¯•</p>
                                <p id="latest-exam-date" style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">-</p>
                            </div>
                            <div style="width: 56px; height: 56px; border-radius: 16px; background: linear-gradient(135deg, #fdf4ff, #fae8ff); display: flex; align-items: center; justify-content: center;">
                                <svg width="28" height="28" fill="none" stroke="#a855f7" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘æˆç»© -->
                <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.75rem;">âš¡</span> æœ€è¿‘æˆç»©
                    </h2>
                   <div id="ai-container" style="display:none; margin-bottom: 1rem;">
                   <div id="ai-comment-box" style="background: #ecfdf5; border: 2px dashed #10b981; border-radius: 0.75rem; padding: 1rem; color: #047857; line-height: 1.6; font-size: 0.95rem; margin-bottom: 0.5rem; position: relative;">
                    ğŸ¤– äº²çˆ±çš„YTUNerè¯·è€å¿ƒç­‰å¾…~çªçªè€å¸ˆæ­£åœ¨æ‰¹æ”¹...
                 </div>

                 <div id="ai-actions" style="display:none; justify-content: flex-end; gap: 0.5rem;">
                 <button onclick="showReplyInput()" style="font-size: 0.8rem; color: #059669; background: white; border: 1px solid #10b981; padding: 0.3rem 0.8rem; border-radius: 99px; cursor: pointer;">ğŸ’¬ ä¸æœ/å›å˜´</button>
                 </div>

    <div id="reply-input-area" style="display:none; margin-top: 0.5rem; animation: fadeIn 0.3s ease;">
        <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="user-rebuttal" placeholder="è¾“å…¥ä½ æƒ³åé©³çš„è¯..." style="flex: 1; border: 1px solid #d1fae5; border-radius: 0.5rem; padding: 0.5rem; outline: none; font-size: 0.9rem;">
            <button onclick="sendRebuttal()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.9rem;">å‘é€</button>
        </div>
    </div>
</div>
<div id="recent-score-content">
    <div class="empty-state">
        <svg width="64" height="64" fill="none" stroke="#d1d5db" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom: 1rem;">
            <path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <p style="color: #6b7280; margin-bottom: 1rem;">è¿˜æ²¡æœ‰æˆç»©è®°å½•</p>
        <button onclick="showPage('entry')" style="color: #10b981; font-weight: 600; background: none; border: none; cursor: pointer;">å¼€å§‹å½•å…¥ â†’</button>
    </div>
</div>
</div>

                <!-- ç»Ÿè®¡ Tabs -->
                <div class="card" style="padding: 1.5rem; margin-bottom: 2rem;">
                    <div id="dashboard-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; border-bottom: 2px solid #f3f4f6; padding-bottom: 1rem;">
                        <button class="tab-btn active" onclick="switchDashboardTab('overview', this)">æ¦‚è§ˆ</button>
                    </div>
                    <div id="tab-content-overview">
                        <!-- å›¾è¡¨å®¹å™¨ -->
                        <div id="charts-container" style="display: none;">
                            <!-- ç»Ÿè®¡åŒºåŸŸ -->
                            <div id="stats-area"></div>
                            <!-- å›¾è¡¨æ ‡é¢˜å’Œç”»å¸ƒ -->
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem;">ğŸ“ˆ æˆç»©è¶‹åŠ¿</h3>
                                <div style="position: relative; height: 350px; background: white; border: 2px solid #e5e7eb; border-radius: 1rem; padding: 1rem;">
                                    <canvas id="main-chart"></canvas>
                                </div>
                                <div id="chart-no-data" class="empty-state" style="display: none;">
                                    <p style="color: #9ca3af;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆå½•å…¥æˆç»©</p>
                                </div>
                            </div>
                        </div>
                        <div id="overview-empty" class="empty-state" style="padding: 2rem;">
                            <p style="color: #9ca3af;">é€‰æ‹©ä¸Šæ–¹è€ƒè¯•ç±»å‹æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡</p>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®ç®¡ç† -->
                <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.75rem;">ğŸ’¾</span> æ•°æ®ç®¡ç†
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                        <div class="stat-box">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.25rem;">å¯¼å‡ºå¤‡ä»½</h3>
                                    <p style="color: #6b7280; font-size: 0.875rem;">å¯¼å‡ºæ‰€æœ‰æˆç»©å’Œè®¾ç½®</p>
                                </div>
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: #eff6ff; display: flex; align-items: center; justify-content: center;">
                                    <svg width="24" height="24" fill="none" stroke="#3b82f6" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                </div>
                            </div>
                            <button class="btn-secondary" onclick="exportData()" style="width: 100%;">å¯¼å‡ºæ•°æ®</button>
                            <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.75rem;">å…± <span id="record-count">0</span> æ¡è®°å½•</p>
                        </div>
                        <div class="stat-box">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.25rem;">å¯¼å…¥å¤‡ä»½</h3>
                                    <p style="color: #6b7280; font-size: 0.875rem;">ä»æ–‡ä»¶æ¢å¤æ•°æ®</p>
                                </div>
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: #ecfdf5; display: flex; align-items: center; justify-content: center;">
                                    <svg width="24" height="24" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                    </svg>
                                </div>
                            </div>
                            <label class="btn-primary" style="display: block; text-align: center; cursor: pointer;">
                                é€‰æ‹©æ–‡ä»¶
                                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importData(this)">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- å†å²è®°å½• -->
                <div class="card" style="padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.75rem;">ğŸ“œ</span> å†å²è®°å½•
                        </h2>
                        <button onclick="clearAllRecords()" style="color: #ef4444; background: none; border: none; cursor: pointer; font-weight: 500;">æ¸…ç©ºæ‰€æœ‰</button>
                    </div>
                    <div id="records-list"></div>
                </div>
            </div>

            <!-- å½•å…¥æˆç»© -->
            <div id="page-entry" class="page hidden">
                <div class="card" style="padding: 2rem; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem;">é€‰æ‹©è€ƒè¯•ç±»å‹</h2>
                    <div id="exam-type-selector" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem;"></div>
                </div>
                <div id="entry-form-container" class="card" style="padding: 2rem;">
                    <div class="empty-state">
                        <svg width="64" height="64" fill="none" stroke="#d1d5db" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom: 1rem;">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p style="color: #6b7280;">è¯·é€‰æ‹©ä¸Šæ–¹è€ƒè¯•ç±»å‹å¼€å§‹å½•å…¥</p>
                    </div>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰è€ƒè¯• -->
            <div id="page-custom" class="page hidden">
                <div class="card" style="padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">è‡ªå®šä¹‰è€ƒè¯•ç±»å‹</h2>
                            <p style="color: #6b7280;">åˆ›å»ºä½ è‡ªå·±çš„è€ƒè¯•è¯„åˆ†ç³»ç»Ÿ</p>
                        </div>
                        <button class="btn-primary" onclick="openCreateModal()">+ æ–°å»ºè€ƒè¯•</button>
                    </div>
                    <div id="custom-exam-list"></div>
                </div>
            </div>
        </main>

        <!-- åˆ›å»ºè€ƒè¯•æ¨¡æ€æ¡† -->
        <div id="create-modal" class="modal-overlay" onclick="closeModalOnBackdrop(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.75rem; font-weight: 700;" class="gradient-text">æ–°å»ºè€ƒè¯•ç±»å‹</h2>
                    <button onclick="closeCreateModal()" style="background: none; border: none; font-size: 1.5rem; color: #9ca3af; cursor: pointer;">Ã—</button>
                </div>
                <form id="create-exam-form" onsubmit="submitCreateForm(event)">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">è€ƒè¯•åç§°</label>
                        <input type="text" id="new-exam-name" required class="input" placeholder="å¦‚ï¼šæ‰˜ç¦ã€GRE">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="new-exam-desc" class="input" placeholder="ç®€çŸ­æè¿°">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label style="font-weight: 500;">ç§‘ç›®è®¾ç½®</label>
                            <button type="button" onclick="addSubject()" style="color: #10b981; background: none; border: none; cursor: pointer; font-weight: 500;">+ æ·»åŠ ç§‘ç›®</button>
                        </div>
                        <div id="subjects-list"></div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn-secondary" onclick="closeCreateModal()" style="flex: 1;">å–æ¶ˆ</button>
                        <button type="submit" class="btn-primary" style="flex: 1;">åˆ›å»º</button>
                    </div>
                </form>
            </div>
        </div>

    <footer style="text-align: center; padding: 2rem; color: #9ca3af;">
    <p style="margin-bottom: 0.25rem;">Designed by Liu Yuntian</p>
    <p style="margin-bottom: 0.25rem;">Copyright Â© YTUN 2026 All Rights Reserved</p>
    <p style="font-size: 0.875rem; opacity: 0.8;">MyScore V6.3</p>
    </footer>
    </div>

    <script>
        // ==================== æ•°æ®å­˜å‚¨ ====================
        const STORAGE = {
            RECORDS: 'myscore_v51_records',  // ä¿æŒä¸V5.2å…¼å®¹
            CUSTOM: 'myscore_v51_custom'
        };

        // å›¾è¡¨å®ä¾‹å˜é‡
        let mainChartInstance = null;

        // å†…ç½®è€ƒè¯•é…ç½®
        const BUILTIN_EXAMS = {
            ielts: {
                id: 'ielts',
                name: 'é›…æ€',
                desc: 'IELTS Academic',
                icon: 'ğŸ“‹',
                builtin: true,
                calcTotal: true,
                subjects: [
                    { id: 'listening', name: 'Listening', short: 'L', color: '#3b82f6', type: 'lookup', min: 0, max: 40, dec: 1 },
                    { id: 'reading', name: 'Reading', short: 'R', color: '#10b981', type: 'lookup', min: 0, max: 40, dec: 1 },
                    { id: 'writing', name: 'Writing', short: 'W', color: '#f59e0b', type: 'ielts-writing', min: 0, max: 9, step: 0.5, dec: 1, hasTasks: true },
                    { id: 'speaking', name: 'Speaking', short: 'S', color: '#8b5cf6', type: 'direct', min: 0, max: 9, step: 0.5, dec: 1 }
                ]
            },
            cet4: {
                id: 'cet4',
                name: 'å››çº§',
                desc: 'CET-4',
                icon: 'ğŸ“š',
                builtin: true,
                calcTotal: true,
                subjects: [
                    { id: 'listening', name: 'å¬åŠ›', short: 'å¬', color: '#3b82f6', type: 'sections', sections: [
                        { name: 'çŸ­å¯¹è¯', score: 7.1, max: 8 },
                        { name: 'é•¿å¯¹è¯', score: 7.1, max: 7 },
                        { name: 'çŸ­æ–‡', score: 14.2, max: 10 }
                    ], dec: 0 },
                    { id: 'reading', name: 'é˜…è¯»', short: 'è¯»', color: '#10b981', type: 'sections', sections: [
                        { name: 'é€‰è¯å¡«ç©º', score: 3.55, max: 10 },
                        { name: 'é•¿ç¯‡é˜…è¯»', score: 7.1, max: 10 },
                        { name: 'ä»”ç»†é˜…è¯»', score: 14.2, max: 10 }
                    ], dec: 0 },
                    { id: 'writing', name: 'å†™ä½œ', short: 'å†™', color: '#f59e0b', type: 'formula', min: 0, max: 15, mult: 7.1, dec: 0 },
                    { id: 'translation', name: 'ç¿»è¯‘', short: 'è¯‘', color: '#ef4444', type: 'formula', min: 0, max: 15, mult: 7.1, dec: 0 }
                ]
            },
            cet6: {
                id: 'cet6',
                name: 'å…­çº§',
                desc: 'CET-6',
                icon: 'ğŸ“',
                builtin: true,
                calcTotal: true,
                subjects: [
                    { id: 'listening', name: 'å¬åŠ›', short: 'å¬', color: '#3b82f6', type: 'sections', sections: [
                        { name: 'é•¿å¯¹è¯', score: 7.1, max: 8 },
                        { name: 'å¬åŠ›ç¯‡ç« ', score: 7.1, max: 7 },
                        { name: 'è®²åº§', score: 14.2, max: 10 }
                    ], dec: 0 },
                    { id: 'reading', name: 'é˜…è¯»', short: 'è¯»', color: '#10b981', type: 'sections', sections: [
                        { name: 'é€‰è¯å¡«ç©º', score: 3.55, max: 10 },
                        { name: 'é•¿ç¯‡é˜…è¯»', score: 7.1, max: 10 },
                        { name: 'ä»”ç»†é˜…è¯»', score: 14.2, max: 10 }
                    ], dec: 0 },
                    { id: 'writing', name: 'å†™ä½œ', short: 'å†™', color: '#f59e0b', type: 'formula', min: 0, max: 15, mult: 7.1, dec: 0 },
                    { id: 'translation', name: 'ç¿»è¯‘', short: 'è¯‘', color: '#ef4444', type: 'formula', min: 0, max: 15, mult: 7.1, dec: 0 }
                ]
            }
        };

        // é›…æ€æŸ¥æ‰¾è¡¨
        const IELTS_TABLES = {
            listening: [
                {min:39,max:40,s:9.0},{min:37,max:38,s:8.5},{min:35,max:36,s:8.0},{min:32,max:34,s:7.5},
                {min:30,max:31,s:7.0},{min:26,max:29,s:6.5},{min:23,max:25,s:6.0},{min:18,max:22,s:5.5},
                {min:16,max:17,s:5.0},{min:13,max:15,s:4.5},{min:10,max:12,s:4.0},{min:6,max:9,s:3.5},
                {min:4,max:5,s:3.0},{min:3,max:3,s:2.5},{min:2,max:2,s:2.0},{min:1,max:1,s:1.0},{min:0,max:0,s:0.5}
            ],
            reading: [
                {min:39,max:40,s:9.0},{min:37,max:38,s:8.5},{min:35,max:36,s:8.0},{min:33,max:34,s:7.5},
                {min:30,max:32,s:7.0},{min:27,max:29,s:6.5},{min:23,max:26,s:6.0},{min:19,max:22,s:5.5},
                {min:15,max:18,s:5.0},{min:13,max:14,s:4.5},{min:10,max:12,s:4.0},{min:8,max:9,s:3.5},
                {min:6,max:7,s:3.0},{min:4,max:5,s:2.5},{min:3,max:3,s:2.5},{min:2,max:2,s:2.0},{min:1,max:1,s:1.0},{min:0,max:0,s:0.5}
            ]
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        function getRecords() {
            const d = localStorage.getItem(STORAGE.RECORDS);
            return d ? JSON.parse(d) : [];
        }

        function saveRecords(r) {
            localStorage.setItem(STORAGE.RECORDS, JSON.stringify(r));
        }

        function getCustom() {
            const d = localStorage.getItem(STORAGE.CUSTOM);
            return d ? JSON.parse(d) : {};
        }

        function saveCustom(c) {
            localStorage.setItem(STORAGE.CUSTOM, JSON.stringify(c));
        }

        function allExams() {
            return { ...BUILTIN_EXAMS, ...getCustom() };
        }

        function roundUp(n) { return Math.ceil(n); }

        function calcIeltsOverall(scores) {
            const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
            const dec = avg - Math.floor(avg);
            if (dec >= 0.25 && dec < 0.5) return Math.floor(avg) + 0.5;
            if (dec >= 0.75) return Math.floor(avg) + 1.0;
            return Math.round(avg * 2) / 2;
        }

        // é›…æ€å†™ä½œ Task1/Task2 åŠ æƒè®¡ç®— (Task2å 2/3, Task1å 1/3)
        function calcWritingScore(t1, t2) {
            if (t1 === null || t2 === null) return null;
            const score = (t2 * 2 + t1) / 3;
            return Math.round(score * 2) / 2;
        }

        function lookup(raw, type) {
            const table = IELTS_TABLES[type];
            if (!table) return parseFloat(raw) || 0;
            const v = parseInt(raw) || 0;
            for (const item of table) {
                if (v >= item.min && v <= item.max) return item.s;
            }
            return 0;
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + p).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + p).classList.add('active');

            if (p === 'dashboard') renderDashboard();
            else if (p === 'entry') {
                currentExam = null;
                writingTask1 = null;
                writingTask2 = null;
                renderExamSelector();
                document.getElementById('entry-form-container').innerHTML = '<div class="empty-state"><svg width="64" height="64" fill="none" stroke="#d1d5db" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom:1rem;"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><p style="color:#6b7280;">è¯·é€‰æ‹©ä¸Šæ–¹è€ƒè¯•ç±»å‹å¼€å§‹å½•å…¥</p></div>';
            }
            else if (p === 'custom') renderCustomList();
        }

        // ==================== ä»ªè¡¨ç›˜ ====================
        function renderDashboard() {
            // æ›´æ–°æ¡Œé¢å® ç‰©çš„å¿ƒæƒ…
        if (typeof updatePetMood === 'function') {
        updatePetMood();
        }
            const records = getRecords();
            const exams = allExams();

            document.getElementById('total-count').textContent = records.length;
            const types = [...new Set(records.map(r => r.examType))];
            document.getElementById('exam-types-count').textContent = types.length;
            document.getElementById('record-count').textContent = records.length;
            document.getElementById('latest-exam-date').textContent = records.length ? records[records.length-1].date : '-';

            // æœ€è¿‘æˆç»©
            const recentDiv = document.getElementById('recent-score-content');
            if (!records.length) {
                recentDiv.innerHTML = '<div class="empty-state"><svg width="64" height="64" fill="none" stroke="#d1d5db" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom:1rem;"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><p style="color:#6b7280;margin-bottom:1rem;">è¿˜æ²¡æœ‰æˆç»©è®°å½•</p><button onclick="showPage(\'entry\')" style="color:#10b981;font-weight:600;background:none;border:none;cursor:pointer;">å¼€å§‹å½•å…¥ â†’</button></div>';
            } else {
                const last = records[records.length-1];
                const exam = exams[last.examType];
                const isCet = last.examType === 'cet4' || last.examType === 'cet6';

                let html = '<div style="margin-bottom:0.5rem;color:#6b7280;">' + last.date + ' - ' + (exam ? exam.name : 'æœªçŸ¥') + '</div>';
                html += '<div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">';
                if (exam) {
                    // å…ˆæ˜¾ç¤ºéå†™ä½œç¿»è¯‘çš„ç§‘ç›®
                    for (const s of exam.subjects) {
                        if (isCet && (s.id === 'writing' || s.id === 'translation')) continue;

                        const sc = last.scores[s.id] || 0;
                        html += '<div style="background:' + s.color + '15;border:2px solid ' + s.color + '40;padding:0.75rem 1.25rem;border-radius:0.75rem;text-align:center;min-width:80px;">';
                        html += '<div style="font-size:0.75rem;color:' + s.color + ';font-weight:600;">' + s.name + '</div>';
                        html += '<div style="font-size:1.5rem;font-weight:bold;color:' + s.color + ';">' + sc.toFixed(s.dec) + '</div></div>';
                    }

                    // CETè€ƒè¯•ï¼šåˆå¹¶æ˜¾ç¤ºå†™ä½œå’Œç¿»è¯‘
                    if (isCet) {
                        const writingScore = last.scores['writing'] || 0;
                        const translationScore = last.scores['translation'] || 0;
                        const wtTotal = writingScore + translationScore;
                        const wtColor = '#f59e0b';
                        html += '<div style="background:' + wtColor + '15;border:2px solid ' + wtColor + '40;padding:0.75rem 1.25rem;border-radius:0.75rem;text-align:center;min-width:80px;">';
                        html += '<div style="font-size:0.75rem;color:' + wtColor + ';font-weight:600;">å†™ä½œå’Œç¿»è¯‘</div>';
                        html += '<div style="font-size:1.5rem;font-weight:bold;color:' + wtColor + ';">' + wtTotal + '</div></div>';
                    }
                }
                html += '</div>';
                if (last.total !== null) {
                    html += '<div class="total-preview"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;color:#059669;">æ€»åˆ†</span><span style="font-size:2.5rem;font-weight:bold;" class="gradient-text">' + last.total.toFixed(1) + '</span></div></div>';
                }
                recentDiv.innerHTML = html;
                // å‡†å¤‡å†å²æ•°æ®
const historyRecs = records.filter(r => r.examType === last.examType).map(r => r.total).slice(-5);
// å‘¼å« AI (ä¼ å…¥ï¼šè€ƒè¯•åã€æœ¬æ¬¡æ€»åˆ†ã€å†å²è®°å½•)
fetchAIComment(exam ? exam.name : last.examType, last.total, historyRecs);
            }

            // Tabs
            const tabsDiv = document.getElementById('dashboard-tabs');
            let tabsHtml = '<button class="tab-btn active" onclick="switchDashboardTab(\'overview\', this)">æ¦‚è§ˆ</button>';
            for (const tid of types) {
                const e = exams[tid];
                if (e) tabsHtml += '<button class="tab-btn" onclick="switchDashboardTab(\'' + tid + '\', this)">' + e.icon + ' ' + e.name + '</button>';
            }
            tabsDiv.innerHTML = tabsHtml;

            // å†å²è®°å½•
            const listDiv = document.getElementById('records-list');
            if (!records.length) {
                listDiv.innerHTML = '<div class="empty-state" style="padding:2rem;"><p style="color:#9ca3af;">æš‚æ— å†å²è®°å½•</p></div>';
            } else {
                let listHtml = '';
                for (let i = records.length - 1; i >= 0; i--) {
                    const r = records[i];
                    const e = exams[r.examType];
                    if (!e) continue;

                    const isCet = r.examType === 'cet4' || r.examType === 'cet6';
                    let badges = '';

                    for (const s of e.subjects) {
                        if (isCet && (s.id === 'writing' || s.id === 'translation')) continue;
                        const sc = r.scores[s.id] || 0;
                        badges += '<span class="score-badge" style="background:' + s.color + '15;color:' + s.color + ';">' + s.short + ': ' + sc.toFixed(s.dec) + '</span>';
                    }

                    if (isCet) {
                        const writingScore = r.scores['writing'] || 0;
                        const translationScore = r.scores['translation'] || 0;
                        const wtTotal = writingScore + translationScore;
                        const wtColor = '#f59e0b';
                        badges += '<span class="score-badge" style="background:' + wtColor + '15;color:' + wtColor + ';">å†™ä½œå’Œç¿»è¯‘: ' + wtTotal + '</span>';
                    }

                    listHtml += '<div class="record-box"><div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;"><span style="font-size:1.25rem;">' + e.icon + '</span><span style="font-weight:700;">' + e.name + '</span><span style="color:#9ca3af;font-size:0.875rem;">' + r.date + '</span></div><div>' + badges + '</div></div><div style="display:flex;align-items:center;gap:1rem;">';
                    if (r.total !== null) {
                        listHtml += '<div style="text-align:right;"><div style="font-size:0.75rem;color:#9ca3af;">æ€»åˆ†</div><div style="font-size:1.75rem;font-weight:bold;" class="gradient-text">' + r.total.toFixed(1) + '</div></div>';
                    }
                    listHtml += '<button onclick="deleteRecord(' + r.id + ')" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:1.5rem;">Ã—</button></div></div></div>';
                }
                listDiv.innerHTML = listHtml;
            }
        }

        function switchDashboardTab(tab, btnElement) {
            // ä½¿ç”¨ä¼ å…¥çš„btnElementè€Œä¸æ˜¯event.target
            const btn = btnElement || event.target;
            
            // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            // æ·»åŠ activeçŠ¶æ€åˆ°å½“å‰æŒ‰é’®
            btn.classList.add('active');
            
            const container = document.getElementById('tab-content-overview');
            const chartsContainer = document.getElementById('charts-container');
            const overviewEmpty = document.getElementById('overview-empty');

            if (tab === 'overview') {
                // æ˜¾ç¤ºæ¦‚è§ˆ
                overviewEmpty.style.display = 'block';
                chartsContainer.style.display = 'none';
                return;
            }

            const exams = allExams();
            const exam = exams[tab];
            const recs = getRecords().filter(r => r.examType === tab);

            overviewEmpty.style.display = 'none';
            if (!recs.length) {
                overviewEmpty.innerHTML = '<p style="color:#9ca3af;">æš‚æ— ' + (exam ? exam.name : '') + 'æ•°æ®</p>';
                chartsContainer.style.display = 'none';
                return;
            }

            // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡ - ä¸ç ´åchartsContainer
            let statsHtml = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem;">';
            statsHtml += '<div class="stat-box"><p style="color:#6b7280;font-size:0.875rem;">è€ƒè¯•æ¬¡æ•°</p><p style="font-size:2rem;font-weight:bold;" class="gradient-text">' + recs.length + '</p></div>';
            statsHtml += '<div class="stat-box"><p style="color:#6b7280;font-size:0.875rem;">æœ€è¿‘</p><p style="font-size:1.25rem;font-weight:bold;">' + recs[recs.length-1].date + '</p></div>';
            if (exam.calcTotal) {
                const totals = recs.map(r => r.total);
                statsHtml += '<div class="stat-box"><p style="color:#6b7280;font-size:0.875rem;">æœ€ä½³</p><p style="font-size:2rem;font-weight:bold;color:#3b82f6;">' + Math.max(...totals).toFixed(1) + '</p></div>';
                statsHtml += '<div class="stat-box"><p style="color:#6b7280;font-size:0.875rem;">å¹³å‡</p><p style="font-size:2rem;font-weight:bold;color:#8b5cf6;">' + (totals.reduce((a,b)=>a+b,0)/totals.length).toFixed(1) + '</p></div>';
            }
            statsHtml += '</div>';

            // æ›´æ–°ç»Ÿè®¡åŒºåŸŸ
            const statsArea = document.getElementById('stats-area');
            if (statsArea) {
                statsArea.innerHTML = statsHtml;
            } else {
                overviewEmpty.innerHTML = statsHtml;
            }

            // æ¸²æŸ“å›¾è¡¨
            chartsContainer.style.display = 'block';
            renderMainChart(tab, recs, exam);
        }

        // ==================== å›¾è¡¨æ¸²æŸ“ ====================
        function renderMainChart(examType, records, exam) {
            const canvas = document.getElementById('main-chart');
            const noDataEl = document.getElementById('chart-no-data');
            if (!canvas) return;

            if (mainChartInstance) {
                mainChartInstance.destroy();
                mainChartInstance = null;
            }

            if (records.length === 0) {
                noDataEl.style.display = 'block';
                canvas.parentElement.style.display = 'none';
                return;
            }

            noDataEl.style.display = 'none';
            canvas.parentElement.style.display = 'block';

            const sorted = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));

            // æ ¹æ®è€ƒè¯•ç±»å‹å‡†å¤‡æ•°æ®
            let datasets = [];
            const examId = examType;

            if (examId === 'ielts') {
                // é›…æ€å›¾è¡¨
                datasets = [
                    { label: 'Overall', data: sorted.map(r => r.total), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 3, fill: true, tension: 0.3, pointRadius: 5 },
                    { label: 'Listening', data: sorted.map(r => r.scores.listening || 0), borderColor: '#3b82f6', borderWidth: 2, tension: 0.3, pointRadius: 4 },
                    { label: 'Reading', data: sorted.map(r => r.scores.reading || 0), borderColor: '#10b981', borderWidth: 2, tension: 0.3, pointRadius: 4 },
                    { label: 'Writing', data: sorted.map(r => r.scores.writing || 0), borderColor: '#f59e0b', borderWidth: 2, tension: 0.3, pointRadius: 4 },
                    { label: 'Speaking', data: sorted.map(r => r.scores.speaking || 0), borderColor: '#8b5cf6', borderWidth: 2, tension: 0.3, pointRadius: 4 }
                ];
            } else if (examId === 'cet4' || examId === 'cet6') {
                // å››å…­çº§å›¾è¡¨ - å†™ä½œå’Œç¿»è¯‘åˆå¹¶æ˜¾ç¤º
                const color = examId === 'cet4' ? '#10b981' : '#8b5cf6';
                datasets = [
                    { label: 'æ€»åˆ†', data: sorted.map(r => r.total), borderColor: color, backgroundColor: color + '20', borderWidth: 3, fill: true, tension: 0.3, pointRadius: 5 },
                    { label: 'å¬åŠ›', data: sorted.map(r => r.scores.listening || 0), borderColor: '#3b82f6', borderWidth: 2, tension: 0.3, pointRadius: 4 },
                    { label: 'é˜…è¯»', data: sorted.map(r => r.scores.reading || 0), borderColor: '#10b981', borderWidth: 2, tension: 0.3, pointRadius: 4 },
                    { label: 'å†™ä½œå’Œç¿»è¯‘', data: sorted.map(r => (r.scores.writing || 0) + (r.scores.translation || 0)), borderColor: '#f59e0b', borderWidth: 2, tension: 0.3, pointRadius: 4 }
                ];
            } else {
                // è‡ªå®šä¹‰è€ƒè¯• - æ˜¾ç¤ºæ€»åˆ†å’Œå„ç§‘ç›®
                datasets = [
                    { label: 'æ€»åˆ†', data: sorted.map(r => r.total), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 3, fill: true, tension: 0.3, pointRadius: 5 }
                ];
                // æ·»åŠ å„ç§‘ç›®æ•°æ®
                for (const s of exam.subjects) {
                    datasets.push({
                        label: s.name,
                        data: sorted.map(r => r.scores[s.id] || 0),
                        borderColor: s.color,
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 4
                    });
                }
            }

            const ctx = canvas.getContext('2d');
            mainChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(r => r.date),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, padding: 15 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ==================== å†å²è®°å½• ====================
        function renderHistoryRecords() {
            const records = getRecords();
            const exams = allExams();
            const listDiv = document.getElementById('records-list');
            
            if (!records.length) {
                listDiv.innerHTML = '<div class="empty-state" style="padding:2rem;"><p style="color:#9ca3af;">æš‚æ— å†å²è®°å½•</p></div>';
                return;
            }
            
            let listHtml = '';
            for (let i = records.length - 1; i >= 0; i--) {
                const r = records[i];
                const e = exams[r.examType];
                if (!e) continue;

                const isCet = r.examType === 'cet4' || r.examType === 'cet6';
                let badges = '';

                for (const s of e.subjects) {
                    if (isCet && (s.id === 'writing' || s.id === 'translation')) continue;
                    const sc = r.scores[s.id] || 0;
                    badges += '<span class="score-badge" style="background:' + s.color + '15;color:' + s.color + ';">' + s.short + ': ' + sc.toFixed(s.dec) + '</span>';
                }

                if (isCet) {
                    const writingScore = r.scores['writing'] || 0;
                    const translationScore = r.scores['translation'] || 0;
                    const wtTotal = writingScore + translationScore;
                    const wtColor = '#f59e0b';
                    badges += '<span class="score-badge" style="background:' + wtColor + '15;color:' + wtColor + ';">å†™ä½œå’Œç¿»è¯‘: ' + wtTotal + '</span>';
                }

                listHtml += '<div class="record-box"><div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;"><span style="font-size:1.25rem;">' + e.icon + '</span><span style="font-weight:700;">' + e.name + '</span><span style="color:#9ca3af;font-size:0.875rem;">' + r.date + '</span></div><div>' + badges + '</div></div><div style="display:flex;align-items:center;gap:1rem;">';
                if (r.total !== null) {
                    listHtml += '<div style="text-align:right;"><div style="font-size:0.75rem;color:#9ca3af;">æ€»åˆ†</div><div style="font-size:1.75rem;font-weight:bold;" class="gradient-text">' + r.total.toFixed(1) + '</div></div>';
                }
                listHtml += '<button onclick="deleteRecord(' + r.id + ')" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:1.5rem;">Ã—</button></div></div></div>';
            }
            listDiv.innerHTML = listHtml;
        }

        function deleteRecord(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
            saveRecords(getRecords().filter(r => r.id !== id));
            renderDashboard();
        }

        function clearAllRecords() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            localStorage.removeItem(STORAGE.RECORDS);
            renderDashboard();
        }


        // ==================== å½•å…¥æˆç»© ====================
        let currentExam = null;
        let writingTask1 = null;
        let writingTask2 = null;

        function renderExamSelector() {
            const exams = allExams();
            const container = document.getElementById('exam-type-selector');
            let html = '';
            for (const [id, e] of Object.entries(exams)) {
                html += '<div class="exam-card" onclick="selectExam(\'' + id + '\')"><div style="font-size:2.5rem;margin-bottom:0.5rem;">' + e.icon + '</div><div style="font-weight:700;">' + e.name + '</div><div style="font-size:0.875rem;color:#9ca3af;">' + e.desc + '</div></div>';
            }
            container.innerHTML = html;
        }

        function selectExam(id) {
            currentExam = id;
            writingTask1 = null;
            writingTask2 = null;
            const exams = allExams();
            const exam = exams[id];

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.exam-card').forEach((c, i) => {
                const keys = Object.keys(exams);
                c.classList.toggle('active', keys[i] === id);
            });

            // æ¸²æŸ“è¡¨å•
            let html = '<form onsubmit="submitScore(event)">';
            html += '<div style="margin-bottom:1.5rem;"><label style="display:block;margin-bottom:0.5rem;font-weight:500;">è€ƒè¯•æ—¥æœŸ</label><input type="date" id="score-date" required class="input" style="max-width:200px;"></div>';

            for (let i = 0; i < exam.subjects.length; i++) {
                const s = exam.subjects[i];
                const open = i === 0 ? 'expanded' : '';
                const arrow = i === 0 ? 'expanded' : '';
                const theme = s.id === 'listening' ? 'listening' : s.id === 'reading' ? 'reading' : s.id === 'writing' ? 'writing' : s.id === 'speaking' ? 'speaking' : 'translation';

                html += '<div class="subject-box ' + theme + '">';
                html += '<div class="accordion-header" onclick="toggleAcc(this)">';
                html += '<div style="display:flex;align-items:center;gap:0.75rem;">';
                html += '<div style="width:40px;height:40px;border-radius:10px;background:' + s.color + ';display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">' + s.short + '</div>';
                html += '<div style="font-weight:700;font-size:1.125rem;">' + s.name + '</div></div>';
                html += '<svg class="accordion-arrow ' + arrow + '" fill="none" stroke="#6b7280" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>';
                html += '</div>';
                html += '<div class="accordion-content ' + open + '"><div style="padding:0 1.25rem 1.25rem;">';

                // é›…æ€å†™ä½œç‰¹æ®Šå¤„ç† - Task1/Task2
                if (s.type === 'ielts-writing') {
                    html += '<div style="margin-bottom:1rem;">';
                    html += '<label style="display:block;margin-bottom:0.5rem;font-size:0.875rem;color:#b45309;font-weight:500;">æ€»åˆ† (0-9ï¼Œæ­¥é•¿0.5)</label>';
                    html += '<input type="number" id="sub-' + s.id + '" min="0" max="9" step="0.5" class="input" placeholder="è¾“å…¥æ€»åˆ†" oninput="updateTotalPreview()">';
                    html += '</div>';
                    html += '<div style="border-top:2px solid #fcd34d;padding-top:1rem;margin-top:1rem;">';
                    html += '<div style="margin-bottom:1rem;">';
                    html += '<label style="display:block;margin-bottom:0.5rem;font-size:0.875rem;color:#b45309;">Task 1 (å°ä½œæ–‡)</label>';
                    html += '<input type="number" id="task1-' + s.id + '" min="0" max="9" step="0.5" class="input" placeholder="Task1 åˆ†æ•°" oninput="onTaskInput(1, this.value)">';
                    html += '</div>';
                    html += '<div style="margin-bottom:1rem;">';
                    html += '<label style="display:block;margin-bottom:0.5rem;font-size:0.875rem;color:#b45309;">Task 2 (å¤§ä½œæ–‡)</label>';
                    html += '<input type="number" id="task2-' + s.id + '" min="0" max="9" step="0.5" class="input" placeholder="Task2 åˆ†æ•°" oninput="onTaskInput(2, this.value)">';
                    html += '</div>';
                    html += '<div style="background:rgba(255,255,255,0.7);border:2px solid #fcd34d;border-radius:0.75rem;padding:1rem;">';
                    html += '<div style="font-size:0.875rem;color:#b45309;font-weight:500;">è‡ªåŠ¨è®¡ç®— (Task2Ã—2 + Task1) Ã· 3</div>';
                    html += '<div id="writing-calc" style="font-size:1.5rem;font-weight:bold;color:#b45309;">-</div>';
                    html += '</div>';
                    html += '</div>';
                }
                else if (s.type === 'direct') {
                    html += '<input type="number" id="sub-' + s.id + '" min="' + s.min + '" max="' + s.max + '" step="' + (s.step || 1) + '" class="input" placeholder="' + s.min + '-' + s.max + '" oninput="updateTotalPreview()">';
                }
                else if (s.type === 'lookup') {
                    html += '<input type="number" id="sub-' + s.id + '" min="' + s.min + '" max="' + s.max + '" class="input" placeholder="æ­£ç¡®é¢˜æ•° (' + s.min + '-' + s.max + ')" oninput="updateLookup(this, \'' + s.id + '\')">';
                    html += '<div style="margin-top:0.75rem;padding:0.75rem;background:' + s.color + '15;border-radius:0.5rem;border:2px solid ' + s.color + '30;">';
                    html += '<span style="color:' + s.color + ';font-weight:500;">æŠ˜ç®—åˆ†: </span>';
                    html += '<strong id="calc-' + s.id + '" style="color:' + s.color + ';font-size:1.25rem;">-</strong>';
                    html += '</div>';
                }
                else if (s.type === 'sections') {
                    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-bottom:0.75rem;">';
                    for (const sec of s.sections) {
                        html += '<div><label style="display:block;font-size:0.75rem;color:#6b7280;margin-bottom:0.25rem;">' + sec.name + ' (' + sec.score + 'åˆ†/é¢˜)</label><input type="number" id="sub-' + s.id + '-' + sec.name + '" min="0" max="' + sec.max + '" class="input" placeholder="0-' + sec.max + '" oninput="updateSections(this, \'' + s.id + '\')"></div>';
                    }
                    html += '</div>';
                    html += '<div style="padding:0.75rem;background:' + s.color + '15;border-radius:0.5rem;border:2px solid ' + s.color + '30;">';
                    html += '<span style="color:' + s.color + ';font-weight:500;">æ€»åˆ†: </span>';
                    html += '<strong id="calc-' + s.id + '" style="color:' + s.color + ';font-size:1.25rem;">-</strong>';
                    html += '</div>';
                }
                else if (s.type === 'subquestions') {
                    html += '<div style="margin-bottom:0.75rem;"><label style="font-size:0.875rem;color:#6b7280;">å„å°é¢˜å¾—åˆ†ï¼š</label></div>';
                    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-bottom:0.75rem;">';
                    for (const sq of s.subquestions) {
                        html += '<div><label style="display:block;font-size:0.75rem;color:#6b7280;margin-bottom:0.25rem;">' + sq.name + ' (æ»¡åˆ†' + sq.max + ')</label><input type="number" id="sub-' + s.id + '-' + sq.name + '" min="0" max="' + sq.max + '" class="input" placeholder="0-' + sq.max + '" oninput="updateSubQuestions(this, \'' + s.id + '\')"></div>';
                    }
                    html += '</div>';
                    html += '<div style="padding:0.75rem;background:' + s.color + '15;border-radius:0.5rem;border:2px solid ' + s.color + '30;">';
                    html += '<span style="color:' + s.color + ';font-weight:500;">å°é¢˜æ€»åˆ†: </span>';
                    html += '<strong id="calc-' + s.id + '" style="color:' + s.color + ';font-size:1.25rem;">-</strong>';
                    html += '</div>';
                }
                else if (s.type === 'formula') {
                    html += '<input type="number" id="sub-' + s.id + '" min="' + s.min + '" max="' + s.max + '" step="0.5" class="input" placeholder="åŸå§‹åˆ† (' + s.min + '-' + s.max + ')" oninput="updateFormula(this, \'' + s.id + '\', ' + s.mult + ')">';
                    html += '<div style="margin-top:0.75rem;padding:0.75rem;background:' + s.color + '15;border-radius:0.5rem;border:2px solid ' + s.color + '30;">';
                    html += '<span style="color:' + s.color + ';font-weight:500;">æŠ˜ç®—åˆ† (Ã—' + s.mult + '): </span>';
                    html += '<strong id="calc-' + s.id + '" style="color:' + s.color + ';font-size:1.25rem;">-</strong>';
                    html += '</div>';
                }

                html += '</div></div></div>';
            }

            if (exam.calcTotal) {
                html += '<div class="total-preview" style="margin:1.5rem 0;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                html += '<span style="font-weight:700;color:#059669;">' + (exam.id === 'ielts' ? 'Overall' : 'æ€»åˆ†é¢„è§ˆ') + '</span>';
                html += '<span id="preview-total" style="font-size:2.5rem;font-weight:bold;" class="gradient-text">-</span>';
                html += '</div></div>';
            }

            html += '<button type="submit" class="btn-primary" style="width:100%;">ğŸ’¾ ä¿å­˜æˆç»©</button>';
            html += '</form>';

            document.getElementById('entry-form-container').innerHTML = html;
            document.getElementById('score-date').value = new Date().toISOString().split('T')[0];
        }

        function toggleAcc(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.accordion-arrow');
            const isExpanded = content.classList.contains('expanded');
            
            document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('expanded'));
            document.querySelectorAll('.accordion-arrow').forEach(a => a.classList.remove('expanded'));
            
            if (!isExpanded) {
                content.classList.add('expanded');
                arrow.classList.add('expanded');
            }
        }

        function onTaskInput(task, val) {
            const score = parseFloat(val);
            if (task === 1) writingTask1 = isNaN(score) ? null : score;
            else writingTask2 = isNaN(score) ? null : score;

            if (writingTask1 !== null && writingTask2 !== null) {
                const total = calcWritingScore(writingTask1, writingTask2);
                document.getElementById('writing-calc').textContent = total.toFixed(1);
                const totalInput = document.getElementById('sub-writing');
                if (totalInput) totalInput.value = total.toFixed(1);
            } else {
                document.getElementById('writing-calc').textContent = '-';
            }
            updateTotalPreview();
        }

        function updateLookup(el, subId) {
            const score = lookup(el.value, subId);
            const calcEl = document.getElementById('calc-' + subId);
            if (calcEl) calcEl.textContent = score.toFixed(1);
            updateTotalPreview();
        }

        function updateSections(el, subId) {
            if (!currentExam) return;
            const exam = allExams()[currentExam];
            if (!exam) return;
            const sub = exam.subjects.find(s => s.id === subId);
            if (!sub || !sub.sections) return;
            
            let sum = 0;
            for (const sec of sub.sections) {
                const inputEl = document.getElementById('sub-' + subId + '-' + sec.name);
                const v = inputEl ? (parseInt(inputEl.value) || 0) : 0;
                sum += v * (sec.score || 0);
            }
            const result = roundUp(sum);
            const calcEl = document.getElementById('calc-' + subId);
            if (calcEl) calcEl.textContent = result;
            updateTotalPreview();
        }

        function updateFormula(el, subId, mult) {
            const raw = parseFloat(el.value) || 0;
            const calcEl = document.getElementById('calc-' + subId);
            if (calcEl) calcEl.textContent = roundUp(raw * mult);
            updateTotalPreview();
        }

        function updateSubQuestions(el, subId) {
            if (!currentExam) return;
            const exam = allExams()[currentExam];
            if (!exam) return;
            const sub = exam.subjects.find(s => s.id === subId);
            if (!sub || !sub.subquestions) return;
            
            let sum = 0;
            for (const sq of sub.subquestions) {
                const inputEl = document.getElementById('sub-' + subId + '-' + sq.name);
                const v = inputEl ? (parseFloat(inputEl.value) || 0) : 0;
                sum += v;
            }
            const calcEl = document.getElementById('calc-' + subId);
            if (calcEl) calcEl.textContent = sum.toFixed(1);
            updateTotalPreview();
        }

        function updateTotalPreview() {
            if (!currentExam) return;
            const exam = allExams()[currentExam];
            if (!exam || !exam.calcTotal) return;

            const scores = [];
            for (const s of exam.subjects) {
                let sc = 0;
                if (s.type === 'ielts-writing') {
                    sc = parseFloat(document.getElementById('sub-' + s.id)?.value) || 0;
                } else if (s.type === 'direct' || s.type === 'lookup') {
                    const el = document.getElementById('sub-' + s.id);
                    sc = s.type === 'lookup' ? lookup(el?.value, s.id) : (parseFloat(el?.value) || 0);
                } else if (s.type === 'sections' || s.type === 'subquestions') {
                    sc = parseFloat(document.getElementById('calc-' + s.id)?.textContent) || 0;
                } else if (s.type === 'formula') {
                    sc = parseInt(document.getElementById('calc-' + s.id)?.textContent) || 0;
                }
                scores.push(sc);
            }

            let total = 0;
            if (exam.id === 'ielts') {
                total = calcIeltsOverall(scores);
            } else {
                total = scores.reduce((a, b) => a + b, 0);
            }
            document.getElementById('preview-total').textContent = total.toFixed(1);
        }

        function submitScore(e) {
            e.preventDefault();
            if (!currentExam) return;

            const exam = allExams()[currentExam];
            const scores = {};

            for (const s of exam.subjects) {
                if (s.type === 'ielts-writing') {
                    scores[s.id] = parseFloat(document.getElementById('sub-' + s.id)?.value) || 0;
                } else if (s.type === 'direct') {
                    scores[s.id] = parseFloat(document.getElementById('sub-' + s.id)?.value) || 0;
                } else if (s.type === 'lookup') {
                    scores[s.id] = lookup(document.getElementById('sub-' + s.id)?.value, s.id);
                } else if (s.type === 'sections' || s.type === 'subquestions') {
                    scores[s.id] = parseFloat(document.getElementById('calc-' + s.id)?.textContent) || 0;
                } else if (s.type === 'formula') {
                    scores[s.id] = parseInt(document.getElementById('calc-' + s.id)?.textContent) || 0;
                }
            }

            let total = null;
            if (exam.calcTotal) {
                const vals = Object.values(scores);
                total = exam.id === 'ielts' ? calcIeltsOverall(vals) : vals.reduce((a, b) => a + b, 0);
            }

            const rec = {
                id: Date.now(),
                examType: currentExam,
                date: document.getElementById('score-date').value,
                scores: scores,
                total: total
            };

            const recs = getRecords();
            recs.push(rec);
            saveRecords(recs);

            alert('æˆç»©ä¿å­˜æˆåŠŸï¼');
            showPage('dashboard');
        }


        // ==================== è‡ªå®šä¹‰è€ƒè¯• ====================
        let customSubs = [];

        function renderCustomList() {
            const custom = getCustom();
            const container = document.getElementById('custom-exam-list');
            if (!Object.keys(custom).length) {
                container.innerHTML = '<div class="empty-state"><p style="color:#9ca3af;">è¿˜æ²¡æœ‰è‡ªå®šä¹‰è€ƒè¯•ç±»å‹</p><p style="font-size:0.875rem;color:#d1d5db;">ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®åˆ›å»º</p></div>';
                return;
            }
            let html = '';
            for (const [id, e] of Object.entries(custom)) {
                let subs = '';
                for (const s of e.subjects) {
                    subs += '<span style="display:inline-block;padding:0.375rem 0.875rem;border-radius:9999px;font-size:0.75rem;margin-right:0.5rem;background:' + s.color + '15;color:' + s.color + ';">' + s.name + '</span>';
                }
                html += '<div class="record-box"><div style="display:flex;justify-content:space-between;align-items:center;"><div style="display:flex;align-items:center;gap:1rem;"><div style="font-size:2rem;">' + e.icon + '</div><div><div style="font-weight:700;">' + e.name + '</div><div style="font-size:0.875rem;color:#9ca3af;">' + (e.desc || 'æ— æè¿°') + '</div><div style="margin-top:0.5rem;">' + subs + '</div></div></div><button onclick="deleteCustom(\'' + id + '\')" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:1.5rem;">Ã—</button></div></div>';
            }
            container.innerHTML = html;
        }

        function openCreateModal() {
            customSubs = [];
            document.getElementById('create-exam-form').reset();
            document.getElementById('subjects-list').innerHTML = '';
            document.getElementById('create-modal').classList.add('active');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
        }

        function closeModalOnBackdrop(e) {
            if (e.target.id === 'create-modal') closeCreateModal();
        }

        function addSubject() {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4'];
            customSubs.push({ id: 'sub_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: '', short: '', color: colors[customSubs.length % colors.length], type: 'direct', min: 0, max: 100 });
            renderSubList();
        }

        function renderSubList() {
            const container = document.getElementById('subjects-list');
            if (!customSubs.length) {
                container.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:1rem;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç§‘ç›®</p>';
                return;
            }
            let html = '';
            for (let i = 0; i < customSubs.length; i++) {
                const s = customSubs[i];
                html += '<div style="padding:1rem;background:#f9fafb;border-radius:0.75rem;margin-bottom:0.75rem;border:2px solid #e5e7eb;">';
                html += '<div style="display:grid;grid-template-columns:1fr 80px 40px;gap:0.5rem;margin-bottom:0.5rem;">';
                html += '<input type="text" placeholder="ç§‘ç›®åç§°" value="' + s.name + '" onchange="customSubs[' + i + '].name=this.value" class="input">';
                html += '<input type="text" placeholder="ç®€ç§°" value="' + s.short + '" onchange="customSubs[' + i + '].short=this.value" class="input">';
                html += '<input type="color" value="' + s.color + '" onchange="customSubs[' + i + '].color=this.value" style="width:40px;height:40px;border:none;border-radius:0.5rem;cursor:pointer;">';
                html += '</div>';
                html += '<select onchange="customSubs[' + i + '].type=this.value;renderSubList()" class="input" style="margin-bottom:0.5rem;">';
                html += '<option value="direct" ' + (s.type === 'direct' ? 'selected' : '') + '>ç›´æ¥è¾“å…¥åˆ†æ•°</option>';
                html += '<option value="subquestions" ' + (s.type === 'subquestions' ? 'selected' : '') + '>å¤šå°é¢˜è®¡åˆ†</option>';
                html += '<option value="sections" ' + (s.type === 'sections' ? 'selected' : '') + '>åˆ†éƒ¨åˆ†è®¡åˆ†</option>';
                html += '<option value="formula" ' + (s.type === 'formula' ? 'selected' : '') + '>å…¬å¼è®¡ç®—</option>';
                html += '</select>';

                if (s.type === 'direct') {
                    html += '<div style="display:flex;gap:0.5rem;"><input type="number" placeholder="æœ€å°å€¼" value="' + s.min + '" onchange="customSubs[' + i + '].min=parseFloat(this.value)" class="input"><input type="number" placeholder="æœ€å¤§å€¼" value="' + s.max + '" onchange="customSubs[' + i + '].max=parseFloat(this.value)" class="input"></div>';
                } else if (s.type === 'subquestions') {
                    if (!s.subquestions) s.subquestions = [{ name: 'å°é¢˜1', max: 10 }];
                    html += '<div id="subqs-' + i + '">';
                    for (let j = 0; j < s.subquestions.length; j++) {
                        const sq = s.subquestions[j];
                        html += '<div style="display:flex;gap:0.5rem;margin-bottom:0.25rem;"><input type="text" placeholder="å°é¢˜åç§°" value="' + sq.name + '" onchange="customSubs[' + i + '].subquestions[' + j + '].name=this.value" class="input" style="flex:1;"><input type="number" placeholder="æ»¡åˆ†" value="' + sq.max + '" onchange="customSubs[' + i + '].subquestions[' + j + '].max=parseFloat(this.value)" class="input" style="width:80px;"></div>';
                    }
                    html += '</div><button type="button" onclick="addSubQuestion(' + i + ')" style="color:#10b981;background:none;border:none;cursor:pointer;font-size:0.875rem;">+ æ·»åŠ å°é¢˜</button>';
                } else if (s.type === 'formula') {
                    html += '<div style="display:flex;gap:0.5rem;"><input type="number" placeholder="åŸå§‹åˆ†æœ€å¤§å€¼" value="' + (s.max || 15) + '" onchange="customSubs[' + i + '].max=parseFloat(this.value)" class="input"><input type="number" placeholder="ä¹˜æ•°" value="' + (s.mult || 7.1) + '" onchange="customSubs[' + i + '].mult=parseFloat(this.value)" class="input"></div>';
                } else if (s.type === 'sections') {
                    if (!s.sections) s.sections = [{ name: 'éƒ¨åˆ†1', score: 1, max: 10 }];
                    html += '<div id="secs-' + i + '">';
                    for (let j = 0; j < s.sections.length; j++) {
                        const sec = s.sections[j];
                        html += '<div style="display:flex;gap:0.5rem;margin-bottom:0.25rem;"><input type="text" placeholder="åç§°" value="' + sec.name + '" onchange="customSubs[' + i + '].sections[' + j + '].name=this.value" class="input" style="flex:1;"><input type="number" placeholder="åˆ†å€¼" value="' + sec.score + '" onchange="customSubs[' + i + '].sections[' + j + '].score=parseFloat(this.value)" class="input" style="width:80px;"><input type="number" placeholder="æœ€å¤§é¢˜æ•°" value="' + sec.max + '" onchange="customSubs[' + i + '].sections[' + j + '].max=parseInt(this.value)" class="input" style="width:80px;"></div>';
                    }
                    html += '</div><button type="button" onclick="addSec(' + i + ')" style="color:#10b981;background:none;border:none;cursor:pointer;font-size:0.875rem;">+ æ·»åŠ éƒ¨åˆ†</button>';
                }

                html += '<button type="button" onclick="removeSub(' + i + ')" style="color:#ef4444;background:none;border:none;cursor:pointer;font-size:0.875rem;margin-top:0.5rem;">åˆ é™¤ç§‘ç›®</button>';
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function addSec(idx) {
            customSubs[idx].sections.push({ name: '', score: 1, max: 10 });
            renderSubList();
        }

        function addSubQuestion(idx) {
            if (!customSubs[idx].subquestions) customSubs[idx].subquestions = [];
            customSubs[idx].subquestions.push({ name: '', max: 10 });
            renderSubList();
        }

        function removeSub(idx) {
            customSubs.splice(idx, 1);
            renderSubList();
        }

        function submitCreateForm(e) {
            e.preventDefault();
            if (!customSubs.length) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªç§‘ç›®ï¼');
                return;
            }
            for (const s of customSubs) {
                if (!s.name || !s.short) {
                    alert('è¯·å¡«å†™æ‰€æœ‰ç§‘ç›®çš„åç§°å’Œç®€ç§°ï¼');
                    return;
                }
            }

            const exam = {
                id: 'custom_' + Date.now(),
                name: document.getElementById('new-exam-name').value,
                desc: document.getElementById('new-exam-desc').value,
                icon: 'ğŸ“',
                builtin: false,
                calcTotal: true,
                subjects: customSubs
            };

            const custom = getCustom();
            custom[exam.id] = exam;
            saveCustom(custom);

            closeCreateModal();
            renderCustomList();
            alert('è€ƒè¯•ç±»å‹åˆ›å»ºæˆåŠŸï¼');
        }

        function deleteCustom(id) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿç›¸å…³æˆç»©ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) return;
            const custom = getCustom();
            delete custom[id];
            saveCustom(custom);
            saveRecords(getRecords().filter(r => r.examType !== id));
            renderCustomList();
        }

        // ==================== å¯¼å…¥å¯¼å‡º ====================
        function exportData() {
            const records = getRecords();
            const custom = getCustom();
            if (!records.length && !Object.keys(custom).length) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            const data = { version: '5.2', date: new Date().toISOString(), records, custom };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'MyScore_Backup_' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '.json';
            a.click();
            URL.revokeObjectURL(url);
            alert('å¯¼å‡ºæˆåŠŸï¼\nè®°å½•: ' + records.length + ' æ¡\nè‡ªå®šä¹‰è€ƒè¯•: ' + Object.keys(custom).length + ' ä¸ª');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.version) throw new Error('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    let newRecs = 0, newExams = 0;
                    if (data.records) {
                        const existing = getRecords();
                        const ids = new Set(existing.map(r => r.id));
                        for (const r of data.records) {
                            if (!ids.has(r.id)) {
                                existing.push(r);
                                newRecs++;
                            }
                        }
                        saveRecords(existing);
                    }
                    if (data.custom) {
                        const existing = getCustom();
                        for (const [id, e] of Object.entries(data.custom)) {
                            if (!existing[id]) {
                                existing[id] = e;
                                newExams++;
                            }
                        }
                        saveCustom(existing);
                    }
                    alert('å¯¼å…¥æˆåŠŸï¼\næ–°è®°å½•: ' + newRecs + ' æ¡\næ–°è€ƒè¯•ç±»å‹: ' + newExams + ' ä¸ª');
                    renderDashboard();
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }       
// å…¨å±€å˜é‡ï¼Œç”¨æ¥è®°ä½ä¸Šä¸‹æ–‡
let lastExamType = '';
let lastScore = 0;
let lastHistory = [];
let lastAiComment = '';

// 1. åˆå§‹è·å–è¯„ä»· (renderDashboard è°ƒç”¨è¿™ä¸ª)
async function fetchAIComment(examType, currentScore, historyScores) {
    // ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œä¸€ä¼šå„¿åµæ¶è¦ç”¨
    lastExamType = examType;
    lastScore = currentScore;
    lastHistory = historyScores;

    const container = document.getElementById('ai-container');
    const box = document.getElementById('ai-comment-box');
    const actions = document.getElementById('ai-actions');
    const replyArea = document.getElementById('reply-input-area');

    if (!container) return;

    // é‡ç½®ç•Œé¢çŠ¶æ€
    container.style.display = 'block';
    actions.style.display = 'none'; // å…ˆè—èµ·æŒ‰é’®
    replyArea.style.display = 'none'; // å…ˆè—èµ·è¾“å…¥æ¡†
    box.innerHTML = 'ğŸ¤– æ¯’èˆŒè€å¸ˆæ­£åœ¨æ¨çœ¼é•œåˆ†æä½ çš„æˆç»©...';
    box.style.background = '#ecfdf5'; // æ¢å¤ç»¿è‰²èƒŒæ™¯

    try {
        const res = await fetch('/.netlify/functions/comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                examType, 
                currentScore, 
                historyScores 
            })
        });

        const data = await res.json();
        
        if (data.comment) {
            lastAiComment = data.comment; // è®°ä½è€å¸ˆéª‚äº†ä»€ä¹ˆ
            box.innerHTML = `<strong>ğŸ‘©â€ğŸ« æ¯’èˆŒè€å¸ˆï¼š</strong> ${data.comment}`;
            actions.style.display = 'flex'; // æ˜¾ç¤º"å›å˜´"æŒ‰é’®
        } else {
            box.innerHTML = 'è€å¸ˆå»åƒé¥­äº†...';
        }
    } catch (err) {
        console.error(err);
        box.innerHTML = 'è€å¸ˆæ–­çº¿äº†...';
    }
}

// 2. æ˜¾ç¤ºè¾“å…¥æ¡†
function showReplyInput() {
    document.getElementById('reply-input-area').style.display = 'block';
    document.getElementById('ai-actions').style.display = 'none'; // éšè—æŒ‰é’®
    document.getElementById('user-rebuttal').focus();
}

// 3. å‘é€å›å˜´ (åµæ¶é€»è¾‘)
async function sendRebuttal() {
    const input = document.getElementById('user-rebuttal');
    const rebuttal = input.value.trim();
    if (!rebuttal) return;

    const box = document.getElementById('ai-comment-box');
    
    // ç•Œé¢å˜èº«ï¼šå˜æˆ"å¯¹æˆ˜ä¸­"çŠ¶æ€
    box.innerHTML = `<strong>ğŸ˜¤ ä½ ï¼š</strong> ${rebuttal}<br><hr style="margin:8px 0; border:0; border-top:1px dashed #a7f3d0">ğŸ¤– è€å¸ˆæ­£åœ¨æ€è€ƒæ€ä¹ˆæ€¼å›æ¥...`;
    box.style.background = '#fff1f2'; // å˜æˆæ·¡çº¢è‰²ï¼Œè¡¨ç¤ºæ°”æ°›ç´§å¼ 
    box.style.color = '#be123c';
    box.style.borderColor = '#fb7185';
    
    document.getElementById('reply-input-area').style.display = 'none'; // éšè—è¾“å…¥æ¡†

    try {
        const res = await fetch('/.netlify/functions/comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                examType: lastExamType, 
                currentScore: lastScore, 
                historyScores: lastHistory,
                userRebuttal: rebuttal,      // é‡ç‚¹ï¼šæŠŠä½ çš„å›å˜´å‘è¿‡å»
                previousComment: lastAiComment // é‡ç‚¹ï¼šæŠŠè€å¸ˆåˆšæ‰çš„è¯å‘è¿‡å»
            })
        });

        const data = await res.json();
        
        if (data.comment) {
            lastAiComment = data.comment; // æ›´æ–°ä¸Šä¸‹æ–‡
            // æ˜¾ç¤ºè¿™ä¸€è½®çš„æˆ˜å†µ
            box.innerHTML = `<strong>ğŸ˜¤ ä½ ï¼š</strong> ${rebuttal}<br><br><strong>ğŸ‘©â€ğŸ« æ¯’èˆŒè€å¸ˆï¼š</strong> ${data.comment}`;
            
            // å…è®¸ç»§ç»­å›å˜´ (æ— é™å¥—å¨ƒ)
            document.getElementById('ai-actions').style.display = 'flex';
            input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }
    } catch (err) {
        box.innerHTML += '<br>(è€å¸ˆè¢«æ°”å¾—æ‰çº¿äº†)';
    }
}
 // ================= æ¡Œé¢å® ç‰©é€»è¾‘ =================

// 1. æ¯’èˆŒè¯­å½•åº“ (æœ¬åœ°å¿«é€Ÿå“åº”ï¼Œä¸ç”¨ç­‰AI)
const SASSY_QUOTES = [
    "çœ‹ä»€ä¹ˆçœ‹ï¼Ÿå•è¯èƒŒå®Œäº†å—ï¼ŸğŸ˜¡",
    "ä½ ä»Šå¤©çš„å¤ä¹ æ—¶é•¿å¦‚æœæ˜¯ 0ï¼Œæˆ‘å¯¹ä½ çš„è¯„ä»·ä¹Ÿæ˜¯ 0ã€‚",
    "è¿™ä¹ˆé—²ï¼Ÿè¿˜æœ‰ç©ºæˆ³æˆ‘ï¼Ÿå»åˆ·é¢˜ï¼ğŸ‘‰",
    "ä¸Šæ¬¡é‚£ç‚¹åˆ†ï¼Œä½ æ€ä¹ˆç¡å¾—ç€è§‰çš„ï¼Ÿ",
    "å†æˆ³æˆ‘ï¼Œæˆ‘å°±æŠŠä½ çš„æˆç»©å‘ç»™ä½ çˆ¸å¦ˆã€‚ğŸ“±",
    "åªæœ‰å¼±è€…æ‰ä¼šåœ¨æ„åˆ«äººçš„è¯„ä»·ï¼Œå¼ºè€…éƒ½åœ¨åˆ·é¢˜ã€‚ğŸ“š",
    "å“Ÿï¼Œè¿™ä¸æ˜¯é‚£ä½æ€»åˆ† 5.5 çš„é€‰æ‰‹å—ï¼ŸğŸ˜",
    "è¿™å°±æ˜¯ä½ å¯¹å¾…å­¦ä¹ çš„æ€åº¦ï¼Ÿå†æˆ³ä¸€ä¸‹è¯•è¯•ï¼ŸğŸ‘Š"
];

// 2. åˆå§‹åŒ–å® ç‰©çŠ¶æ€ (åœ¨ renderDashboard é‡Œè°ƒç”¨)
function updatePetMood() {
    const records = getRecords();
    const avatar = document.getElementById('pet-avatar');
    if (!records.length) {
        avatar.innerHTML = 'ğŸ˜´'; // æ²¡æˆç»©æ—¶åœ¨ç¡è§‰
        return;
    }

    // è·å–æœ€è¿‘ä¸¤æ¬¡æˆç»©æ¥åˆ¤æ–­è¶‹åŠ¿
    const last = records[records.length - 1];
    const prev = records.length > 1 ? records[records.length - 2] : null;
    
    // ç®€å•çš„å˜è„¸é€»è¾‘
    if (!prev) {
        avatar.innerHTML = 'ğŸ˜'; // åªæœ‰ä¸€æ¬¡æˆç»©ï¼Œé¢æ— è¡¨æƒ…
    } else if (last.total > prev.total) {
        avatar.innerHTML = 'ğŸ˜'; // è¿›æ­¥äº†ï¼Œæˆ´å¢¨é•œ
    } else if (last.total < prev.total) {
        avatar.innerHTML = 'ğŸ˜¡'; // é€€æ­¥äº†ï¼Œç”Ÿæ°”
    } else {
        avatar.innerHTML = 'ğŸ˜‘'; // æ²¡å˜åŒ–ï¼Œæ— è¯­
    }
}

// 3. æˆ³ä¸€æˆ³äº’åŠ¨å‡½æ•°
let bubbleTimer = null;
function pokeTeacher() {
    const bubble = document.getElementById('pet-bubble');
    const avatar = document.getElementById('desktop-pet');
    
    // éšæœºé€‰ä¸€å¥éªšè¯
    const randomQuote = SASSY_QUOTES[Math.floor(Math.random() * SASSY_QUOTES.length)];
    bubble.innerText = randomQuote;

    // æ˜¾ç¤ºæ°”æ³¡
    bubble.style.opacity = '1';
    bubble.style.visibility = 'visible';
    bubble.style.transform = 'translateY(-10px)';

    // å¤´åƒæŠ–åŠ¨ç‰¹æ•ˆ
    avatar.style.transform = 'scale(0.9) rotate(-5deg)';
    setTimeout(() => avatar.style.transform = 'scale(1) rotate(0)', 200);

    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    if (bubbleTimer) clearTimeout(bubbleTimer);
    bubbleTimer = setTimeout(() => {
        bubble.style.opacity = '0';
        bubble.style.visibility = 'hidden';
        bubble.style.transform = 'translateY(0)';
    }, 3000);
}

// é¡µé¢åŠ è½½å®Œæˆåï¼Œé¡ºä¾¿åˆå§‹åŒ–ä¸€ä¸‹å¿ƒæƒ…
document.addEventListener('DOMContentLoaded', updatePetMood);
        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function () {
            renderDashboard();
        });
    </script>
 <div id="desktop-pet" onclick="pokeTeacher()" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 999; cursor: pointer; transition: transform 0.2s ease;">
    <div id="pet-bubble" style="
        position: absolute; 
        bottom: 110%; 
        right: 0; 
        width: 220px; 
        background: white; 
        padding: 1rem; 
        border-radius: 1rem 1rem 0 1rem; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        border: 2px solid #10b981;
        color: #374151;
        font-size: 0.9rem;
        opacity: 0; 
        visibility: hidden; 
        transition: all 0.3s ease;
        pointer-events: none;">
        ä»Šå¤©èƒŒå•è¯äº†å—ï¼ŸğŸ˜¡
    </div>
    
    <div id="pet-avatar" style="font-size: 4.5rem; filter: drop-shadow(0 5px 15px rgba(16, 185, 129, 0.3)); user-select: none;">
        ğŸ‘¨â€ğŸ«
    </div>
</div>   
</body>
</html>